import React, { useState, useEffect, useRef, useMemo } from 'react';
import { 
  Plus, Save, Printer, CheckCircle, Truck, 
  FileText, Settings, Users, Scissors, 
  Trash2, Search, X, Edit2, Clock, 
  BarChart2, Calendar, Download, Sparkles, Loader,
  PackageCheck, Archive, Lock, RotateCcw, AlertCircle, Upload, ScanBarcode, KeyRound, LogOut, ChevronRight, ChevronDown, Euro, Building, Coins, CalendarDays, MapPin, Hash, ListPlus, RefreshCcw, PenTool, ArrowUpDown, Tag, Filter, AlertTriangle, Timer, TrendingUp, Layers, ClipboardList, History, Eye, EyeOff, Hourglass, Zap
} from 'lucide-react';

// --- UTILITAIRES ---
const generateId = () => Math.random().toString(36).substr(2, 6).toUpperCase(); 
const formatPrice = (price) => new Intl.NumberFormat('fr-FR', { style: 'currency', currency: 'EUR' }).format(price);
const formatDate = (dateString) => dateString ? new Date(dateString).toLocaleDateString('fr-FR') : '-';
const getTodayDate = () => new Date().toISOString().split('T')[0]; 

// Fonction de regroupement des services (Stacking)
const groupServices = (services, showComments = true) => {
  if (!services) return [];
  const groups = {};
  services.forEach(s => {
    const key = `${s.name}-${s.price}`;
    if (!groups[key]) {
      groups[key] = { name: s.name, price: s.price, count: 0, comments: [] };
    }
    groups[key].count++;
    if (s.comment && s.comment.trim() !== '' && showComments) {
        groups[key].comments.push(s.comment);
    }
  });

  return Object.values(groups).map(g => {
    const qtyPrefix = g.count > 1 ? `${g.count}x ` : '';
    const uniqueComments = [...new Set(g.comments)];
    const commentStr = uniqueComments.length > 0 ? ` (${uniqueComments.join(', ')})` : '';
    return `${qtyPrefix}${g.name}${commentStr}`;
  });
};

// Calcul de la date de livraison par défaut (J+2 ou Lundi/Mardi)
const calculateDefaultDeliveryDate = () => {
  const date = new Date();
  const day = date.getDay(); // 0 = Dimanche, 1 = Lundi, ...
  let daysToAdd = 2; // Par défaut J+2
  if (day === 5) daysToAdd = 3; else if (day === 6) daysToAdd = 3; else if (day === 0) daysToAdd = 2;
  date.setDate(date.getDate() + daysToAdd);
  return date.toISOString().split('T')[0];
};

// --- COMPOSANTS UI ---
const Button = ({ children, onClick, variant = 'primary', className = '', type = 'button', disabled = false, title = '' }) => {
  const baseStyle = "px-4 py-2 rounded-md font-medium transition-colors flex items-center justify-center gap-2";
  const variants = {
    primary: "bg-blue-600 text-white hover:bg-blue-700 disabled:bg-blue-300",
    secondary: "bg-gray-100 text-gray-700 hover:bg-gray-200",
    success: "bg-green-600 text-white hover:bg-green-700",
    warning: "bg-orange-500 text-white hover:bg-orange-600",
    danger: "bg-red-100 text-red-600 hover:bg-red-200",
    outline: "border border-gray-300 text-gray-700 hover:bg-gray-50",
    magic: "bg-gradient-to-r from-purple-600 to-blue-500 text-white hover:from-purple-700 hover:to-blue-600 shadow-md",
    ghost: "text-gray-500 hover:text-gray-700 hover:bg-gray-100 p-1 rounded"
  };
  return <button type={type} onClick={onClick} className={`${baseStyle} ${variants[variant]} ${className}`} disabled={disabled} title={title}>{children}</button>;
};

const Card = ({ title, children, className = '' }) => (
  <div className={`bg-white rounded-lg shadow-sm border border-gray-200 overflow-hidden ${className}`}>
    {title && <div className="px-6 py-4 border-b border-gray-100 bg-gray-50 font-semibold text-gray-800 flex justify-between items-center">{title}</div>}
    <div className="p-6">{children}</div>
  </div>
);

const Toast = ({ message, type, onClose }) => {
    useEffect(() => { const timer = setTimeout(onClose, 3000); return () => clearTimeout(timer); }, [onClose]);
    const bg = type === 'error' ? 'bg-red-500' : 'bg-green-600';
    return (
        <div className={`fixed bottom-4 right-4 ${bg} text-white px-6 py-3 rounded-lg shadow-lg flex items-center gap-3 z-[9999] animate-bounce`}>
            {type === 'error' ? <AlertCircle size={20}/> : <CheckCircle size={20}/>}
            {message}
        </div>
    );
};

const playScanSound = (success = true) => {
  const AudioContext = window.AudioContext || window.webkitAudioContext;
  if (!AudioContext) return;
  const audioCtx = new AudioContext();
  const oscillator = audioCtx.createOscillator();
  const gainNode = audioCtx.createGain();
  oscillator.connect(gainNode);
  gainNode.connect(audioCtx.destination);
  if (success) {
      oscillator.type = 'sine'; oscillator.frequency.setValueAtTime(1000, audioCtx.currentTime); gainNode.gain.setValueAtTime(0.1, audioCtx.currentTime); 
      oscillator.start(); oscillator.stop(audioCtx.currentTime + 0.1); 
  } else {
      oscillator.type = 'sawtooth'; oscillator.frequency.setValueAtTime(200, audioCtx.currentTime); gainNode.gain.setValueAtTime(0.1, audioCtx.currentTime); 
      oscillator.start(); oscillator.stop(audioCtx.currentTime + 0.3); 
  }
};

// --- APPLICATION PRINCIPALE ---
export default function App() {
  const [activeTab, setActiveTab] = useState('reception');
  const [notification, setNotification] = useState(null);
  const [receptionPrintData, setReceptionPrintData] = useState(null);
  const [blCounter, setBlCounter] = useState(() => parseInt(localStorage.getItem('blCounter')) || 1);
  const [isAuthenticated, setIsAuthenticated] = useState(false);
  const [passwordInput, setPasswordInput] = useState('');
  const [adminPassword, setAdminPassword] = useState(() => localStorage.getItem('adminPassword') || '1234');
  
  const [companyInfo, setCompanyInfo] = useState(() => {
      const saved = localStorage.getItem('companyInfo');
      return saved ? JSON.parse(saved) : { name: 'MA RETOUCHERIE', address: '12 Rue de la Couture, 75000 Paris', siret: '000 000 000', footer: 'Merci de votre confiance.' };
  });

  const [clients, setClients] = useState(() => {
    const saved = localStorage.getItem('clients');
    return saved ? JSON.parse(saved) : [{ id: 'c1', name: 'Boutique Élégance', email: 'contact@elegance.com', address: '', siret: '', tva: '', autoGenerateBt: false, btPrefix: '', nextBtSequence: 1, isHeadquarters: false, headquartersId: '' }];
  });

  const [categories, setCategories] = useState(() => {
      const saved = localStorage.getItem('categories');
      return saved ? JSON.parse(saved) : [{ id: 'cat1', name: 'Pantalon' }, { id: 'cat2', name: 'Veste' }, { id: 'cat3', name: 'Jupe/Robe' }];
  });

  const [services, setServices] = useState(() => {
    const saved = localStorage.getItem('services');
    return saved ? JSON.parse(saved) : [
      { id: 's1', categoryId: 'cat1', name: 'Ourlet Simple', standardPrice: 10 },
      { id: 's2', categoryId: 'cat1', name: 'Ourlet Invisible', standardPrice: 12 },
      { id: 's3', categoryId: 'cat2', name: 'Cintrage', standardPrice: 25 }
    ];
  });

  const [specificPrices, setSpecificPrices] = useState(() => {
    const saved = localStorage.getItem('specificPrices');
    return saved ? JSON.parse(saved) : [];
  });

  const [workOrders, setWorkOrders] = useState(() => {
    const saved = localStorage.getItem('workOrders');
    return saved ? JSON.parse(saved) : [];
  });

  const [editingBt, setEditingBt] = useState(null);

  useEffect(() => localStorage.setItem('clients', JSON.stringify(clients)), [clients]);
  useEffect(() => localStorage.setItem('categories', JSON.stringify(categories)), [categories]);
  useEffect(() => localStorage.setItem('services', JSON.stringify(services)), [services]);
  useEffect(() => localStorage.setItem('specificPrices', JSON.stringify(specificPrices)), [specificPrices]);
  useEffect(() => localStorage.setItem('workOrders', JSON.stringify(workOrders)), [workOrders]);
  useEffect(() => localStorage.setItem('adminPassword', adminPassword), [adminPassword]);
  useEffect(() => localStorage.setItem('companyInfo', JSON.stringify(companyInfo)), [companyInfo]);
  useEffect(() => localStorage.setItem('blCounter', blCounter), [blCounter]);

  const showToast = (msg, type = 'success') => setNotification({ message: msg, type });
  
  const getPrice = (clientId, serviceId) => {
    const client = clients.find(c => c.id === clientId);
    const specific = specificPrices.find(sp => sp.clientId === clientId && sp.serviceId === serviceId);
    if (specific) return specific.price;
    if (client && client.headquartersId) {
        const hqSpecific = specificPrices.find(sp => sp.clientId === client.headquartersId && sp.serviceId === serviceId);
        if (hqSpecific) return hqSpecific.price;
    }
    const service = services.find(s => s.id === serviceId);
    return service ? service.standardPrice : 0;
  };

  const createWorkOrder = (btData) => {
    if (workOrders.some(bt => bt.id === btData.id)) { showToast("Ce numéro de BT existe déjà !", 'error'); return null; }
    const newBT = { ...btData, scheduledDeliveryDate: btData.deliveryDate, dateCreated: new Date().toISOString(), status: 'ATELIER', dateDelivered: null };
    setWorkOrders(prev => [newBT, ...prev]);
    return newBT;
  };

  const handleLogin = (e) => { e.preventDefault(); if (passwordInput === adminPassword) { setIsAuthenticated(true); setPasswordInput(''); } else { showToast("Mot de passe incorrect", 'error'); } };
  const deleteBT = (id) => { if(window.confirm("Supprimer définitivement ce bon ?")) { setWorkOrders(prev => prev.filter(bt => bt.id !== id)); showToast("Bon supprimé"); } };
  const openEditModal = (bt) => { if (bt.status === 'FACTURE') return showToast("Impossible : Facturé", 'error'); let btToEdit = JSON.parse(JSON.stringify(bt)); if (!btToEdit.pieces) btToEdit.pieces = []; setEditingBt(btToEdit); };
  const saveEditedBT = () => {
      if (!editingBt.pieces || editingBt.pieces.length === 0) { setWorkOrders(prev => prev.filter(bt => bt.id !== editingBt.id)); showToast("BT vide supprimé"); } 
      else { setWorkOrders(prev => prev.map(bt => bt.id === editingBt.id ? editingBt : bt)); showToast("Modifications enregistrées"); }
      setEditingBt(null);
  };

  const EditModal = () => {
      if (!editingBt) return null;
      const [addPieceMode, setAddPieceMode] = useState(false);
      const [newPieceCat, setNewPieceCat] = useState('');
      const [addingServiceToPieceIndex, setAddingServiceToPieceIndex] = useState(null);
      const updatePiece = (idx, field, value) => { const newPieces = [...editingBt.pieces]; newPieces[idx][field] = value; setEditingBt({...editingBt, pieces: newPieces}); };
      const removePiece = (idx) => { const newPieces = editingBt.pieces.filter((_, i) => i !== idx); setEditingBt({...editingBt, pieces: newPieces}); };
      const removeServiceFromPiece = (pieceIdx, serviceIdx) => { const newPieces = [...editingBt.pieces]; newPieces[pieceIdx].services.splice(serviceIdx, 1); setEditingBt({...editingBt, pieces: newPieces}); };
      const updateServicePrice = (pieceIdx, serviceIdx, newPrice) => { const newPieces = [...editingBt.pieces]; newPieces[pieceIdx].services[serviceIdx].price = parseFloat(newPrice); setEditingBt({...editingBt, pieces: newPieces}); };
      const addNewPiece = () => { if (!newPieceCat) return; const category = categories.find(c => c.id === newPieceCat); const newPiece = { categoryId: newPieceCat, categoryName: category?.name || 'Inconnu', designation: '', quantity: 1, labelCount: 1, services: [] }; setEditingBt({...editingBt, pieces: [...editingBt.pieces, newPiece]}); setNewPieceCat(''); setAddPieceMode(false); };
      const addServiceToPiece = (pieceIdx, serviceId) => { const service = services.find(s => s.id === serviceId); if (!service) return; const newPieces = [...editingBt.pieces]; newPieces[pieceIdx].services.push({ id: service.id, name: service.name, price: getPrice(editingBt.clientId, service.id), comment: '' }); setEditingBt({...editingBt, pieces: newPieces}); setAddingServiceToPieceIndex(null); };

      return (
          <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-[10000] p-4">
              <div className="bg-white rounded-lg shadow-xl w-full max-w-3xl overflow-hidden flex flex-col max-h-[90vh]">
                  <div className="p-4 border-b flex justify-between items-center bg-blue-600 text-white"><h3 className="font-bold text-lg flex items-center gap-2"><Edit2 size={18}/> Modifier le BT #{editingBt.id}</h3><button onClick={() => setEditingBt(null)} className="hover:bg-blue-700 p-1 rounded"><X size={20}/></button></div>
                  <div className="p-6 overflow-y-auto flex-1">
                      <div className="grid grid-cols-2 gap-4 mb-6">
                          <div><label className="block text-sm font-bold text-gray-700 mb-1">Client</label><select className="w-full border p-2 rounded" value={editingBt.clientId} onChange={e => setEditingBt({...editingBt, clientId: e.target.value})}>{clients.map(c => <option key={c.id} value={c.id}>{c.name}</option>)}</select></div>
                          <div><label className="block text-sm font-bold text-gray-700 mb-1">Livraison Prévue</label><input type="date" className="w-full border p-2 rounded" value={editingBt.scheduledDeliveryDate || calculateDefaultDeliveryDate()} onChange={e => setEditingBt({...editingBt, scheduledDeliveryDate: e.target.value})} /></div>
                      </div>
                      <div className="space-y-4">
                          <div className="flex justify-between items-center border-b pb-2"><label className="block text-sm font-bold text-gray-700">Contenu ({editingBt.pieces ? editingBt.pieces.length : 0} pièces)</label><Button size="sm" onClick={() => setAddPieceMode(true)}><Plus size={16}/> Ajouter Pièce</Button></div>
                          {addPieceMode && (<div className="bg-blue-50 p-3 rounded border border-blue-200 mb-4"><label className="block text-xs font-bold text-blue-800 mb-2">Choisir Type :</label><div className="flex flex-wrap gap-2 mb-2">{categories.map(c => (<button key={c.id} onClick={() => setNewPieceCat(c.id)} className={`px-3 py-1 rounded text-sm border ${newPieceCat === c.id ? 'bg-blue-600 text-white' : 'bg-white'}`}>{c.name}</button>))}</div><div className="flex justify-end gap-2"><Button variant="ghost" onClick={() => setAddPieceMode(false)} size="sm">Annuler</Button><Button onClick={addNewPiece} size="sm" disabled={!newPieceCat}>Valider</Button></div></div>)}
                          {editingBt.pieces && editingBt.pieces.map((piece, pIdx) => (
                              <div key={pIdx} className="border rounded p-3 bg-gray-50">
                                  <div className="flex justify-between mb-2"><div className="font-bold text-blue-800 flex items-center gap-2">{piece.categoryName} <input className="text-xs font-normal border-b border-gray-300 bg-transparent focus:bg-white px-1" value={piece.designation || ''} onChange={(e) => updatePiece(pIdx, 'designation', e.target.value)} placeholder="Commentaire..."/></div><div className="flex gap-2 items-center"><span className="text-xs bg-blue-100 text-blue-800 px-2 py-1 rounded">x{piece.quantity}</span><button onClick={() => removePiece(pIdx)} className="text-red-500 hover:text-red-700"><Trash2 size={16}/></button></div></div>
                                  <div className="pl-4 border-l-2 border-blue-200 space-y-1">
                                      {piece.services && piece.services.map((srv, sIdx) => (<div key={sIdx} className="flex justify-between items-center text-sm bg-white p-1 rounded border"><span>{srv.name}</span><div className="flex gap-2 items-center"><input type="number" className="w-16 text-right border rounded px-1 py-0.5" value={srv.price} onChange={(e) => updateServicePrice(pIdx, sIdx, e.target.value)}/><span className="text-gray-500">€</span><button onClick={() => removeServiceFromPiece(pIdx, sIdx)} className="text-red-400 hover:text-red-600 ml-2"><X size={14}/></button></div></div>))}
                                      {addingServiceToPieceIndex === pIdx ? (<div className="bg-white p-2 border rounded shadow-sm mt-2"><div className="text-xs font-bold text-gray-500 mb-1">Ajouter prestation :</div><div className="flex flex-wrap gap-1">{services.filter(s => s.categoryId === piece.categoryId).map(s => (<button key={s.id} onClick={() => addServiceToPiece(pIdx, s.id)} className="text-xs px-2 py-1 bg-gray-100 hover:bg-blue-100 border rounded">{s.name}</button>))}<button onClick={() => setAddingServiceToPieceIndex(null)} className="text-xs px-2 py-1 text-red-500 underline ml-2">Annuler</button></div></div>) : (<button onClick={() => setAddingServiceToPieceIndex(pIdx)} className="text-xs text-blue-600 hover:underline flex items-center gap-1 mt-1"><Plus size={12}/> Ajouter une prestation</button>)}
                                  </div>
                              </div>
                          ))}
                      </div>
                  </div>
                  <div className="p-4 border-t bg-gray-50 flex justify-end gap-2"><Button variant="outline" onClick={() => setEditingBt(null)}>Annuler</Button><Button onClick={saveEditedBT}>Enregistrer</Button></div>
              </div>
          </div>
      );
  };

  const ReceptionModule = () => {
    const [selectedClient, setSelectedClient] = useState(localStorage.getItem('lastSelectedClient') || '');
    const [deliveryDate, setDeliveryDate] = useState(calculateDefaultDeliveryDate());
    const btIdInputRef = useRef(null);
    const commentInputRef = useRef(null); 
    const freeNameRef = useRef(null);
    const [btId, setBtId] = useState(''); 
    const [isAutoGenerated, setIsAutoGenerated] = useState(false); 
    const [currentCat, setCurrentCat] = useState('');
    const [currentComment, setCurrentComment] = useState(''); 
    const [currentServices, setCurrentServices] = useState([]);
    const [labelCount, setLabelCount] = useState(1);
    const [showFreeService, setShowFreeService] = useState(false);
    const [freeServiceName, setFreeServiceName] = useState('');
    const [freeServicePrice, setFreeServicePrice] = useState('');
    const [freeServiceComment, setFreeServiceComment] = useState('');
    const [piecesList, setPiecesList] = useState([]);

    useEffect(() => {
        if(selectedClient) {
            localStorage.setItem('lastSelectedClient', selectedClient);
            const client = clients.find(c => c.id === selectedClient);
            if (client && client.autoGenerateBt && client.btPrefix) {
                const nextSeq = client.nextBtSequence || 1;
                setBtId(`${client.btPrefix}${nextSeq}`);
                setIsAutoGenerated(true);
            } else { setBtId(''); setIsAutoGenerated(false); }
        }
    }, [selectedClient, clients]);
    useEffect(() => { if(showFreeService && freeNameRef.current) freeNameRef.current.focus(); }, [showFreeService]);
    useEffect(() => { const timer = setTimeout(() => { if (btId.length > 2 && selectedClient && !isAutoGenerated) { if (workOrders.some(bt => bt.id === btId.trim())) showToast("Ce numéro de BT existe déjà !", 'error'); } }, 500); return () => clearTimeout(timer); }, [btId, selectedClient, isAutoGenerated, workOrders]);
    useEffect(() => { const handleKeyDown = (e) => { if (e.ctrlKey && e.key === 'Enter') finalizeBT(); }; window.addEventListener('keydown', handleKeyDown); return () => window.removeEventListener('keydown', handleKeyDown); }, [btId, selectedClient, piecesList, deliveryDate]);

    const filteredServices = services.filter(s => s.categoryId === currentCat);
    const startReception = () => { if (!btId.trim()) return showToast("La Réf BT est obligatoire !", 'error'); if (!selectedClient) return showToast("Sélectionnez un client", 'error'); if (workOrders.some(bt => bt.id === btId.trim())) return showToast("Ce numéro de BT existe déjà !", 'error'); };
    const addServiceToCurrentPiece = (serviceId) => { const service = services.find(s => s.id === serviceId); if (!service) return; setCurrentServices([...currentServices, { id: service.id, name: service.name, price: getPrice(selectedClient, service.id), comment: '' }]); };
    const updateCurrentServiceComment = (index, value) => { const updated = [...currentServices]; updated[index].comment = value; setCurrentServices(updated); };
    const addFreeService = () => { if(!freeServiceName || !freeServicePrice) return showToast("Nom et Prix obligatoires", 'error'); setCurrentServices([...currentServices, { id: 'FREE-' + generateId(), name: freeServiceName, price: parseFloat(freeServicePrice), comment: freeServiceComment }]); setFreeServiceName(''); setFreeServicePrice(''); setFreeServiceComment(''); setShowFreeService(false); };
    const addPieceToCart = () => {
        if (!currentCat) return showToast("Type de vêtement ?", 'error');
        if (currentServices.length === 0) return showToast("Aucune prestation", 'error');
        const categoryName = categories.find(c => c.id === currentCat)?.name;
        const servicesWithComments = currentServices.map(s => ({ ...s, name: s.name, comment: s.comment }));
        const signature = (srvs) => JSON.stringify(srvs.map(s => ({name: s.name, price: s.price})).sort((a,b) => a.name.localeCompare(b.name)));
        const existingIndex = piecesList.findIndex(p => p.categoryId === currentCat && p.designation === currentComment && p.labelCount === labelCount && signature(p.services) === signature(servicesWithComments));
        if (existingIndex >= 0) { const newList = [...piecesList]; newList[existingIndex].quantity += 1; setPiecesList(newList); } else { setPiecesList([...piecesList, { categoryId: currentCat, categoryName: categoryName, designation: currentComment, services: servicesWithComments, quantity: 1, labelCount: labelCount }]); }
        setCurrentServices([]); setCurrentComment(''); setLabelCount(1); if(commentInputRef.current) commentInputRef.current.focus();
    };

    const finalizeBT = () => {
        if (!btId.trim()) return showToast("Référence BT manquante !", 'error');
        if (piecesList.length === 0) return showToast("Le panier est vide !", 'error');
        const newOrder = createWorkOrder({ id: btId.trim(), clientId: selectedClient, pieces: piecesList, deliveryDate: deliveryDate });
        if (newOrder) {
            setReceptionPrintData(newOrder); setTimeout(() => window.print(), 300);
            const client = clients.find(c => c.id === selectedClient);
            if (client && client.autoGenerateBt) { setClients(clients.map(c => c.id === client.id ? { ...c, nextBtSequence: (c.nextBtSequence || 1) + 1 } : c)); } else { setBtId(''); }
            setPiecesList([]); setCurrentCat(''); setCurrentComment(''); setCurrentServices([]); showToast("Bon enregistré !");
        }
    };
    
    const resetForm = () => { if (!isAutoGenerated) setBtId(''); setPiecesList([]); setCurrentCat(''); setCurrentServices([]); setCurrentComment(''); };
    const getPiecesSummary = (pieces) => { if (!pieces) return ''; const counts = pieces.reduce((acc, p) => { acc[p.categoryName] = (acc[p.categoryName] || 0) + p.quantity; return acc; }, {}); return Object.entries(counts).map(([name, count]) => `${count}x ${name}`).join(' '); };

    return (
      <div className="flex flex-col md:flex-row gap-6 h-[calc(100vh-120px)]">
        {receptionPrintData && (<div className="hidden print:block fixed inset-0 bg-white z-[9999] p-0 m-0"><style>{`@import url('https://fonts.googleapis.com/css2?family=Libre+Barcode+39+Text&display=swap'); @media print { @page { size: 80mm auto; margin: 0; } body { margin: 0; padding: 0; } .ticket { page-break-after: always; padding: 5mm; width: 80mm; border-bottom: 2px dashed black; } }`}</style>{receptionPrintData.pieces && receptionPrintData.pieces.flatMap(p => Array(p.labelCount || 1).fill(p).map((_, labelIndex) => ({...p, labelIndex, totalLabels: p.labelCount || 1}))).map((piece, i, arr) => (<div key={i} className="ticket text-center font-sans"><div className="text-sm font-black mb-1 truncate">{companyInfo.name}</div><div className="text-lg mb-1 font-black uppercase">{clients.find(c=>c.id===receptionPrintData.clientId)?.name}</div><div className="text-3xl font-black mb-1">BT: {receptionPrintData.id}</div><div className="text-base font-black mb-1 border-b-2 border-black pb-1">(Total: {receptionPrintData.pieces.reduce((acc,p)=>acc+p.quantity,0)} pces)</div><div className="text-sm font-bold mb-1 border-2 border-black rounded px-2 inline-block bg-gray-100">Ticket {i + 1} / {arr.length}</div><div className="font-black text-xl border-t-2 border-black mt-2 pt-1 uppercase leading-none">{getPiecesSummary(receptionPrintData.pieces)}</div><div className="text-base italic mb-2 font-bold">{piece.designation}</div><ul className="text-left text-lg border-b-2 border-black pb-2 mb-2 font-black leading-tight">{groupServices(piece.services, true).map((s, idx) => (<li key={idx}>• {s}</li>))}</ul><div className="text-5xl my-1" style={{ fontFamily: '"Libre Barcode 39 Text", cursive' }}>{`*${receptionPrintData.id}*`}</div><div className="text-xl font-bold mt-1">Prévu le : {formatDate(receptionPrintData.scheduledDeliveryDate)}</div></div>))}</div>)}
        <div className="w-full md:w-2/3 flex flex-col gap-6 overflow-y-auto">
            <Card title="1. Configuration du Bon">
                <div className="grid grid-cols-1 md:grid-cols-2 gap-4"><div className="md:col-span-2"><label className="block text-xs font-bold text-gray-500 uppercase mb-1">Magasin</label><div className="flex gap-2"><select className="w-full border-2 border-blue-100 p-2 rounded font-bold text-blue-900" value={selectedClient} onChange={e => setSelectedClient(e.target.value)}><option value="">-- Choisir --</option>{clients.map(c => <option key={c.id} value={c.id}>{c.name}</option>)}</select>{selectedClient && <Button variant="ghost" onClick={() => {setSelectedClient(''); localStorage.removeItem('lastSelectedClient')}} title="Changer"><RefreshCcw size={16}/></Button>}</div></div><div className="md:col-span-2"><label className="block text-xs font-bold text-blue-600 uppercase mb-1">Référence BT</label><input ref={btIdInputRef} readOnly={isAutoGenerated} className={`w-full border-2 p-3 rounded text-xl font-mono font-bold text-center outline-none ${isAutoGenerated ? 'bg-gray-100 border-gray-300 text-gray-500' : 'border-blue-400 focus:ring-4 focus:ring-blue-200'}`} placeholder={isAutoGenerated ? "Génération Auto..." : "Scannez l'étiquette ici..."} value={btId} onChange={e => setBtId(e.target.value.toUpperCase())} onKeyDown={e => e.key === 'Enter' && startReception()} />{isAutoGenerated && <div className="text-xs text-center text-gray-400 mt-1 italic">Numéro généré automatiquement</div>}</div></div>
            </Card>
            <Card title="2. Ajout de Pièce">
                 <div className="space-y-4">
                    <div className="grid grid-cols-2 gap-4"><div><label className="text-xs font-bold uppercase text-gray-500 block mb-2">Type</label><div className="flex flex-wrap gap-2 mb-2">{categories.map(c => (<button key={c.id} onClick={() => { setCurrentCat(c.id); setCurrentServices([]); }} className={`px-4 py-2 rounded text-sm font-medium border transition-all shadow-sm ${currentCat === c.id ? 'bg-blue-600 text-white border-blue-600' : 'bg-white text-gray-700 border-gray-200 hover:bg-gray-50'}`}>{c.name}</button>))}</div></div><div><label className="text-xs font-bold uppercase text-gray-500 block mb-1">COMMENTAIRE</label><input ref={commentInputRef} className="w-full border p-2 rounded" placeholder="Détails..." value={currentComment} onChange={e => setCurrentComment(e.target.value)} onKeyDown={e => e.key === 'Enter' && addPieceToCart()} /></div></div>
                    <div className="bg-gray-50 p-3 rounded border"><label className="font-bold block mb-2 text-sm">Prestations :</label><div className="flex flex-wrap gap-2">{filteredServices.length === 0 && <span className="text-gray-400 text-xs italic">Sélectionnez un type.</span>}{filteredServices.map(s => (<button key={s.id} onClick={() => { addServiceToCurrentPiece(s.id); commentInputRef.current?.focus(); }} className="px-4 py-2 bg-white border border-blue-200 rounded hover:bg-blue-50 text-sm font-medium flex items-center gap-1 transition-all active:scale-95 shadow-sm"><Plus size={14} className="text-blue-500"/> {s.name} <span className="text-gray-400 ml-1">{formatPrice(getPrice(selectedClient, s.id))}</span></button>))}{currentCat && (<button onClick={() => setShowFreeService(true)} className="px-4 py-2 bg-purple-50 border border-purple-200 rounded hover:bg-purple-100 text-sm font-medium flex items-center gap-1 transition-all text-purple-700 shadow-sm"><PenTool size={14}/> Autre</button>)}</div></div>
                    {showFreeService && (<div className="bg-purple-50 p-3 rounded border border-purple-200 space-y-2"><h5 className="font-bold text-purple-800 text-sm">Libre</h5><div className="flex gap-2"><input ref={freeNameRef} className="flex-1 border p-1 rounded text-sm" placeholder="Nom" value={freeServiceName} onChange={e => setFreeServiceName(e.target.value)} /><input className="w-20 border p-1 rounded text-sm" type="number" placeholder="Prix" value={freeServicePrice} onChange={e => setFreeServicePrice(e.target.value)} /></div><input className="w-full border p-1 rounded text-sm" placeholder="Commentaire" value={freeServiceComment} onChange={e => setFreeServiceComment(e.target.value)} /><div className="flex justify-end gap-2"><Button variant="outline" onClick={() => setShowFreeService(false)}>Annuler</Button><Button onClick={addFreeService}>Ajouter</Button></div></div>)}
                    {currentServices.length > 0 && (<div className="bg-blue-50 p-3 rounded border border-blue-200"><div className="text-sm mb-2 space-y-2"><div className="font-bold text-blue-900 border-b border-blue-200 pb-1 mb-2">{categories.find(c=>c.id===currentCat)?.name} en cours...</div>{currentServices.map((s, idx) => (<div key={idx} className="flex items-center gap-2 bg-white p-2 rounded border border-blue-100"><span className="text-blue-800 font-medium whitespace-nowrap">{s.name}</span><input autoFocus={idx === currentServices.length - 1} className="flex-1 border-b border-gray-300 text-xs p-1 focus:outline-none focus:border-blue-500 bg-transparent" placeholder="Ajouter un commentaire..." value={s.comment || ''} onChange={(e) => updateCurrentServiceComment(idx, e.target.value)} onKeyDown={e => e.key === 'Enter' && addPieceToCart()}/><button onClick={() => setCurrentServices(currentServices.filter((_, i) => i !== idx))} className="text-red-400 hover:text-red-600"><X size={14}/></button></div>))}</div><div className="flex justify-between items-center border-t border-blue-200 pt-2 mt-2"><div className="flex items-center gap-2"><label className="text-xs font-bold text-blue-900">Nb. Étiquettes :</label><input type="number" min="1" max="5" className="w-12 border p-1 rounded text-center text-sm font-bold" value={labelCount} onChange={e => setLabelCount(parseInt(e.target.value) || 1)} /></div><Button onClick={addPieceToCart} size="sm"><ListPlus size={16}/> Ajouter</Button></div></div>)}
                 </div>
            </Card>
        </div>
        <div className="w-full md:w-1/3 h-full">
            <Card title={`Panier ${btId || '...'}`} className="h-full flex flex-col">
                <div className="flex-1 overflow-y-auto space-y-2 mb-4 bg-gray-50 p-2 rounded border-inner h-0 min-h-[300px]">{piecesList.length === 0 && <div className="text-center text-gray-400 mt-10 italic">Vide</div>}{piecesList.map((p, idx) => (<div key={idx} className="bg-white border rounded p-2 text-sm shadow-sm relative pr-8"><div className="flex justify-between font-bold"><span>{p.categoryName} {p.labelCount > 1 && <span className="text-xs text-orange-500 font-normal">({p.labelCount} t.)</span>}</span><span className="bg-blue-100 text-blue-800 px-1.5 rounded text-xs">x{p.quantity}</span></div><div className="text-xs text-gray-500">{p.designation}</div><div className="text-xs mt-1 text-gray-600">{groupServices(p.services, false).join(', ')}</div><button onClick={() => setPiecesList(piecesList.filter((_, i) => i !== idx))} className="absolute top-2 right-2 text-red-300 hover:text-red-500"><Trash2 size={14}/></button></div>))}</div>
                <div className="pt-2 border-t space-y-2"><div className="mb-2 bg-blue-50 p-2 rounded border border-blue-100"><label className="block text-xs font-bold text-blue-800 uppercase mb-1 text-center">Livraison Prévue</label><input type="date" className="w-full border-2 border-blue-200 p-2 rounded font-bold text-gray-800 text-center cursor-pointer hover:bg-blue-50 focus:bg-white transition-colors" value={deliveryDate} onChange={e => setDeliveryDate(e.target.value)} required /></div><Button onClick={finalizeBT} className="w-full py-3 text-lg font-bold"><Save size={20}/> VALIDER</Button><button onClick={resetForm} className="text-xs text-gray-400 hover:text-red-500 underline w-full text-center">Annuler</button></div>
            </Card>
        </div>
      </div>
    );
  };

  const WorkshopModule = () => {
    const [filters, setFilters] = useState({ query: '', client: '', status: 'ATELIER', start: localStorage.getItem('workshop_start') || '', end: localStorage.getItem('workshop_end') || '' });
    const [printData, setPrintData] = useState(null);
    const [scanInput, setScanInput] = useState('');
    const scanRef = useRef(null);

    useEffect(() => { localStorage.setItem('workshop_start', filters.start); localStorage.setItem('workshop_end', filters.end); }, [filters.start, filters.end]);
    const handlePrint = (bt) => { setPrintData(bt); setTimeout(() => window.print(), 500); };
    const validateScan = (code) => {
        const rawId = code.trim().toUpperCase().replace(/\*/g, '');
        if (!rawId) return;
        setScanInput(''); 
        const bt = workOrders.find(b => b.id === rawId);
        if (!bt) { showToast("BT introuvable", 'error'); playScanSound(false); } 
        else if (bt.status !== 'ATELIER') { showToast(`Déjà traité (${bt.status})`, 'warning'); playScanSound(false); } 
        else { setWorkOrders(prev => prev.map(b => b.id === rawId ? {...b, status: 'A_LIVRER'} : b)); showToast(`BT ${rawId} marqué PRÊT !`); playScanSound(true); }
        setTimeout(() => { if(scanRef.current) scanRef.current.focus(); }, 50);
    };

    useEffect(() => { const timer = setTimeout(() => { if (scanInput.length >= 3) validateScan(scanInput); }, 100); return () => clearTimeout(timer); }, [scanInput]);
    const markAsReady = (btId) => { setWorkOrders(prev => prev.map(bt => bt.id === btId ? { ...bt, status: 'A_LIVRER' } : bt)); showToast("Ticket prêt !"); };
    
    const filteredBTs = useMemo(() => {
        return workOrders.filter(bt => {
            const search = filters.query.toLowerCase();
            const hasActiveSearch = search.length > 0;
            if (filters.status && bt.status !== filters.status) return false;
            if (filters.client && bt.clientId !== filters.client) return false;
            if (!hasActiveSearch) { if (filters.start && bt.scheduledDeliveryDate < filters.start) return false; if (filters.end && bt.scheduledDeliveryDate > filters.end) return false; }
            if (hasActiveSearch) { const clientName = clients.find(c => c.id === bt.clientId)?.name.toLowerCase() || ''; const piecesContent = bt.pieces ? bt.pieces.map(p => `${p.categoryName} ${p.services.map(s=>s.name).join(' ')}`).join(' ').toLowerCase() : ''; return bt.id.toLowerCase().includes(search) || clientName.includes(search) || piecesContent.includes(search); }
            return true;
        }).sort((a,b) => new Date(a.scheduledDeliveryDate || '9999-12-31') - new Date(b.scheduledDeliveryDate || '9999-12-31'));
    }, [workOrders, filters, clients]);

    const tasksSummary = useMemo(() => {
        const summary = {};
        filteredBTs.forEach(bt => { if (bt.pieces) { bt.pieces.forEach(p => { p.services.forEach(s => { const qty = p.quantity || 1; summary[s.name] = (summary[s.name] || 0) + qty; }); }); } });
        return Object.entries(summary).sort((a, b) => b[1] - a[1]);
    }, [filteredBTs]);
    
    const getPiecesSummaryForTicket = (pieces) => { if (!pieces) return ''; const counts = pieces.reduce((acc, p) => { acc[p.categoryName] = (acc[p.categoryName] || 0) + p.quantity; return acc; }, {}); return Object.entries(counts).map(([name, count]) => `${count}x ${name}`).join(' '); };
    const getUrgencyColor = (dateStr) => { if (!dateStr) return 'bg-gray-100 text-gray-600'; const target = new Date(dateStr); const today = new Date(); today.setHours(0,0,0,0); target.setHours(0,0,0,0); const diff = (target - today) / (1000 * 60 * 60 * 24); if (diff < 0) return 'bg-red-100 text-red-800'; if (diff === 0) return 'bg-purple-100 text-purple-800'; if (diff === 1) return 'bg-orange-100 text-orange-800'; return 'bg-blue-50 text-blue-600'; };

    return (
      <div className="space-y-4">
        {printData && (<div className="hidden print:block fixed inset-0 bg-white z-[9999] p-0 m-0"><style>{`@import url('https://fonts.googleapis.com/css2?family=Libre+Barcode+39+Text&display=swap'); @media print { @page { size: 80mm auto; margin: 0; } body { margin: 0; padding: 0; } .ticket { page-break-after: always; padding: 5mm; width: 80mm; border-bottom: 2px dashed black; } }`}</style>{printData.pieces && printData.pieces.flatMap(p => Array(p.labelCount || 1).fill(p).map((_, labelIndex) => ({...p, labelIndex, totalLabels: p.labelCount || 1}))).map((piece, i, arr) => (<div key={i} className="ticket text-center font-sans"><div className="text-sm font-black mb-1 truncate">{companyInfo.name}</div><div className="text-lg mb-1 font-black uppercase">{clients.find(c=>c.id===printData.clientId)?.name}</div><div className="text-3xl font-black mb-1">BT: {printData.id}</div><div className="text-base font-black mb-1 border-b-2 border-black pb-1">(Total: {printData.pieces.reduce((acc,p)=>acc+p.quantity,0)} pces)</div><div className="text-sm font-bold mb-1 border-2 border-black rounded px-2 inline-block bg-gray-100">Ticket {i + 1} / {arr.length}</div><div className="font-black text-xl border-t-2 border-black mt-2 pt-1 uppercase leading-none">{getPiecesSummaryForTicket(printData.pieces)}</div><div className="text-base italic mb-2 font-bold">{piece.designation}</div><ul className="text-left text-lg border-b-2 border-black pb-2 mb-2 font-black leading-tight">{groupServices(piece.services, true).map((s, idx) => (<li key={idx}>• {s}</li>))}</ul><div className="text-5xl my-1" style={{ fontFamily: '"Libre Barcode 39 Text", cursive' }}>{`*${printData.id}*`}</div><div className="text-xl font-bold mt-1">Prévu le : {formatDate(printData.scheduledDeliveryDate)}</div></div>))}</div>)}
        <div className="bg-white p-4 rounded-lg shadow border border-gray-200 no-print">
            <div className="flex flex-col gap-4">
                <div className="grid grid-cols-1 md:grid-cols-5 gap-3 items-end">
                    <div className="md:col-span-1"><label className="text-xs font-bold text-gray-500 uppercase mb-1">Recherche</label><div className="relative"><Search className="absolute left-2 top-2.5 text-gray-400" size={16}/><input className="w-full pl-8 p-2 border rounded text-sm" placeholder="BT, Pièce..." value={filters.query} onChange={e => setFilters({...filters, query: e.target.value})} /></div></div>
                    <div><label className="text-xs font-bold text-gray-500 uppercase mb-1">Client</label><select className="w-full border p-2 rounded text-sm" value={filters.client} onChange={e => setFilters({...filters, client: e.target.value})}><option value="">Tous</option>{clients.map(c => <option key={c.id} value={c.id}>{c.name}</option>)}</select></div>
                    <div><label className="text-xs font-bold text-gray-500 uppercase mb-1">Statut</label><select className="w-full border p-2 rounded text-sm font-bold text-blue-800 bg-blue-50" value={filters.status} disabled><option value="ATELIER">ATELIER</option></select></div>
                    <div><label className="text-xs font-bold text-gray-500 uppercase mb-1">Du</label><input type="date" className="w-full border p-2 rounded text-sm" value={filters.start} onChange={e => setFilters({...filters, start: e.target.value})} /></div>
                    <div><label className="text-xs font-bold text-gray-500 uppercase mb-1">Au</label><input type="date" className="w-full border p-2 rounded text-sm" value={filters.end} onChange={e => setFilters({...filters, end: e.target.value})} /></div>
                </div>
                <div className="border-t pt-3 mt-1"><h4 className="text-xs font-bold text-gray-500 uppercase mb-2 flex items-center gap-2"><Layers size={14}/> Total prestations (Liste affichée)</h4><div className="flex gap-2 overflow-x-auto pb-2 scrollbar-thin">{tasksSummary.map(([name, count]) => (<span key={name} className="whitespace-nowrap px-3 py-1 bg-blue-100 text-blue-800 rounded-full text-xs font-bold border border-blue-200 shadow-sm flex items-center gap-1"><span className="bg-white px-1.5 rounded-full text-[10px] text-blue-900">{count}</span> {name}</span>))}{tasksSummary.length === 0 && <span className="text-gray-400 text-xs italic">Aucune tâche en cours</span>}</div></div>
                <div className="border-t pt-3 mt-1 flex items-center gap-4 bg-purple-50 p-3 rounded"><ScanBarcode className="text-purple-600" size={24}/><div className="flex-1"><label className="block text-xs font-bold text-purple-700 uppercase mb-1">Scanner de Sortie Atelier</label><input ref={scanRef} className="w-full border-2 border-purple-300 rounded p-2 text-lg font-mono font-bold focus:ring-2 focus:ring-purple-200 outline-none" placeholder="Scan de FIN..." value={scanInput} onChange={e => setScanInput(e.target.value)} onKeyDown={(e) => e.key === 'Enter' && validateScan(scanInput)} /></div></div>
            </div>
        </div>
        <div className="overflow-x-auto bg-white rounded-lg shadow border">
            <table className="w-full text-sm text-left"><thead className="bg-gray-100 text-gray-600 uppercase text-xs"><tr><th className="p-3">Réception</th><th className="p-3">BT</th><th className="p-3">Client</th><th className="p-3">Contenu</th><th className="p-3 text-right">Actions</th><th className="p-3">Urgence</th></tr></thead><tbody className="divide-y">{filteredBTs.map(bt => (<tr key={bt.id} className="hover:bg-gray-50"><td className="p-3 text-gray-500">{formatDate(bt.dateCreated)}</td><td className="p-3 font-mono font-bold text-blue-600">{bt.id}</td><td className="p-3 font-medium">{clients.find(c=>c.id===bt.clientId)?.name}</td><td className="p-3">{bt.pieces ? bt.pieces.map((p, i) => (<div key={i} className="mb-3 border-l-4 border-blue-100 pl-2"><div className="font-bold text-gray-800">{p.quantity}x {p.categoryName}</div><ul className="text-xs text-blue-700 mt-1 space-y-0.5">{groupServices(p.services, false).map((s, j) => (<li key={j} className="flex items-start gap-1"><span className="text-blue-400">•</span> <span>{s}</span></li>))}</ul></div>)) : <span className="text-red-400 italic">Ancien</span>}</td><td className="p-3 text-right flex justify-end gap-2"><Button variant="ghost" onClick={() => openEditModal(bt)}><Edit2 size={19}/></Button><Button variant="ghost" className="text-red-400" onClick={(e) => {e.stopPropagation(); deleteBT(bt.id)}}><Trash2 size={19}/></Button><Button variant="outline" onClick={() => handlePrint(bt)}><Printer size={19}/></Button><Button variant="primary" onClick={() => markAsReady(bt.id)}><PackageCheck size={19}/></Button></td><td className="p-3"><span className={`px-2 py-1 rounded text-xs font-bold ${getUrgencyColor(bt.scheduledDeliveryDate)}`}>{formatDate(bt.scheduledDeliveryDate)}</span></td></tr>))}{filteredBTs.length === 0 && (<tr><td colSpan="6" className="p-8 text-center text-gray-400 italic">Aucune pièce ne correspond aux filtres.</td></tr>)}</tbody></table>
        </div>
      </div>
    );
  };

  const DeliveryModule = () => {
      const [deliveryClient, setDeliveryClient] = useState(() => localStorage.getItem('lastDeliveryClient') || '');
      const [scanInput, setScanInput] = useState('');
      const scanRef = useRef(null);
      const [printBLData, setPrintBLData] = useState(null);
      const [deliveryStart, setDeliveryStart] = useState(getTodayDate());
      const [deliveryEnd, setDeliveryEnd] = useState(getTodayDate());
      const [deliverySubTab, setDeliverySubTab] = useState('bl'); 
      const [expandedBLs, setExpandedBLs] = useState(new Set());
      const [searchQuery, setSearchQuery] = useState('');

      useEffect(() => { localStorage.setItem('lastDeliveryClient', deliveryClient); }, [deliveryClient, workOrders]); 

      const blHistory = useMemo(() => {
          const history = {};
          workOrders.forEach(bt => {
              if (bt.blNumber && bt.status === 'LIVRE' && (deliveryClient ? bt.clientId === deliveryClient : true)) {
                  if (!history[bt.blNumber]) { history[bt.blNumber] = { blNumber: bt.blNumber, date: bt.dateDelivered, clientId: bt.clientId, clientName: clients.find(c => c.id === bt.clientId)?.name, items: [], totalAmount: 0 }; }
                  history[bt.blNumber].items.push(bt);
                  const btTotal = bt.pieces ? bt.pieces.reduce((accP, p) => accP + p.quantity * p.services.reduce((accS, s) => accS + s.price, 0), 0) : 0;
                  history[bt.blNumber].totalAmount += btTotal;
              }
          });
          return Object.values(history).sort((a, b) => new Date(b.date) - new Date(a.date));
      }, [workOrders, clients, deliveryClient]);

      const displayedItems = useMemo(() => {
          let items = [];
          if (!deliveryClient && deliverySubTab !== 'history') { 
               items = workOrders.filter(bt => { const isScheduledInRange = bt.scheduledDeliveryDate >= deliveryStart && bt.scheduledDeliveryDate <= deliveryEnd; const isNotSent = bt.status !== 'LIVRE' && bt.status !== 'FACTURE' && bt.status !== 'AVOIR' && bt.status !== 'BL_EN_COURS'; return isScheduledInRange && isNotSent; }).sort((a, b) => { if (a.scheduledDeliveryDate !== b.scheduledDeliveryDate) return new Date(a.scheduledDeliveryDate) - new Date(b.scheduledDeliveryDate); const clientA = clients.find(c => c.id === a.clientId)?.name || ''; const clientB = clients.find(c => c.id === b.clientId)?.name || ''; return clientA.localeCompare(clientB); });
          } else {
              if (deliverySubTab === 'planning') { items = workOrders.filter(bt => bt.clientId === deliveryClient && bt.scheduledDeliveryDate >= deliveryStart && bt.scheduledDeliveryDate <= deliveryEnd && !['LIVRE', 'FACTURE', 'AVOIR', 'BL_EN_COURS'].includes(bt.status)).sort((a,b) => new Date(a.scheduledDeliveryDate) - new Date(b.scheduledDeliveryDate)); } 
              else if (deliverySubTab === 'bl') { items = workOrders.filter(bt => (deliveryClient ? bt.clientId === deliveryClient : true) && (bt.status === 'LIVRE' || bt.status === 'BL_EN_COURS') && bt.dateDelivered && bt.dateDelivered.slice(0, 10) >= deliveryStart && bt.dateDelivered.slice(0, 10) <= deliveryEnd).sort((a,b) => new Date(b.dateDelivered) - new Date(a.dateDelivered)); }
          }
          if (searchQuery) { const q = searchQuery.toLowerCase(); items = items.filter(bt => bt.id.toLowerCase().includes(q) || (clients.find(c => c.id === bt.clientId)?.name.toLowerCase().includes(q))); }
          return items;
      }, [workOrders, deliveryClient, clients, deliveryStart, deliveryEnd, deliverySubTab, searchQuery]);

      const totalPieces = useMemo(() => { return displayedItems.reduce((acc, bt) => acc + (bt.pieces ? bt.pieces.reduce((s,p)=>s+p.quantity,0) : 0), 0); }, [displayedItems]);
      const getUrgencyStatus = (dateStr) => { if (!dateStr) return { color: 'bg-gray-100 text-gray-600', label: '-' }; const target = new Date(dateStr); const current = new Date(getTodayDate()); target.setHours(0,0,0,0); current.setHours(0,0,0,0); const diff = (target - current) / (1000 * 60 * 60 * 24); if (diff < 0) return { color: 'bg-red-100 text-red-800 font-bold', label: 'RETARD' }; if (diff === 0) return { color: 'bg-green-100 text-green-800 font-bold', label: 'AUJOURD\'HUI' }; return { color: 'bg-blue-50 text-blue-600', label: 'Futur' }; };
      
      const validateScan = (code) => {
          const rawId = code.trim().toUpperCase().replace(/\*/g, ''); if (!rawId) return; setScanInput(''); 
          const bt = workOrders.find(b => b.id === rawId);
          if (!bt) { showToast(`BT ${rawId} introuvable`, 'error'); playScanSound(false); return; } 
          if (deliveryClient && bt.clientId !== deliveryClient) { showToast(`ERREUR MAGASIN !`, 'error'); playScanSound(false); return; } 
          const today = getTodayDate(); 
          if ((bt.status === 'BL_EN_COURS' || bt.status === 'LIVRE') && bt.dateDelivered && bt.dateDelivered.startsWith(today)) { showToast(`BT ${rawId} déjà scanné.`, 'warning'); playScanSound(false); return; } 
          const now = new Date().toISOString(); setWorkOrders(prev => prev.map(b => b.id === rawId ? { ...b, status: 'BL_EN_COURS', dateDelivered: now } : b)); 
          showToast(`Sortie validée : ${rawId}`, 'success'); playScanSound(true); setTimeout(() => { if(scanRef.current) scanRef.current.focus(); }, 50);
      };

      useEffect(() => { const timer = setTimeout(() => { if (scanInput.length >= 3) validateScan(scanInput); }, 100); return () => clearTimeout(timer); }, [scanInput]);
      const cancelDelivery = (btId) => { if (window.confirm(`Retour Atelier ${btId} ?`)) { setWorkOrders(prev => prev.map(b => b.id === btId ? { ...b, status: 'A_LIVRER', dateDelivered: null } : b)); showToast("BT retiré du BL"); } };
      const handlePrintBL = (itemsToPrint = displayedItems, dateToPrint = deliveryEnd, blNum = null) => {
          if (itemsToPrint.length === 0) return showToast("Rien à imprimer", 'error');
          const clientName = deliveryClient ? clients.find(c => c.id === deliveryClient)?.name : "PLANNING LIVRAISON DU JOUR";
          let generatedBlNumber = blNum || (deliveryClient ? `BL${new Date().getFullYear()}-${blCounter.toString().padStart(4, '0')}` : "PROVISOIRE");
          setPrintBLData({ items: itemsToPrint, date: new Date(dateToPrint).toLocaleDateString(), clientName, blNumber: generatedBlNumber, isSpecificClient: !!deliveryClient && !!blNum });
          setTimeout(() => { window.print(); if (deliveryClient && !blNum && deliverySubTab === 'bl') { if(window.confirm(`Confirmer sortie stock ${generatedBlNumber} ?`)) { const ids = itemsToPrint.map(i => i.id); setWorkOrders(prev => prev.map(bt => ids.includes(bt.id) ? {...bt, status: 'LIVRE', blNumber: generatedBlNumber} : bt)); setBlCounter(prev => prev + 1); showToast(`BL ${generatedBlNumber} Validé !`); } } }, 500);
      };

      const toggleBL = (blNumber) => { const newSet = new Set(expandedBLs); if (newSet.has(blNumber)) newSet.delete(blNumber); else newSet.add(blNumber); setExpandedBLs(newSet); };

      return (
          <div className="flex flex-col gap-6 h-[calc(100vh-120px)]">
              {printBLData && ( <div className="hidden print:block fixed inset-0 bg-white z-[9999] p-4 font-sans text-sm"><style>{`@media print { @page { size: A4; margin: 10mm; } }`}</style><div className="flex justify-between items-start border-b-2 border-black pb-2 mb-4"><div className="w-1/2"><h1 className="text-2xl font-bold uppercase">{companyInfo.name}</h1><div className="text-xs whitespace-pre-line">{companyInfo.address}</div></div><div className="w-1/2 text-right"><h2 className="text-xl font-bold">{deliveryClient ? `BON DE LIVRAISON N° ${printBLData.blNumber}` : "PLANNING LIVRAISON"}</h2><div className="text-sm">Date : <b>{printBLData.date}</b></div><div className="text-sm mt-1">Pour : <b>{printBLData.clientName}</b></div></div></div><table className="w-full border-collapse border border-black text-xs"><thead className="bg-gray-200"><tr><th className="border border-black p-1 w-16 text-center">BT</th><th className="border border-black p-1 w-12 text-center">Qté</th><th className="border border-black p-1">{deliveryClient ? 'Description' : 'Client & Description'}</th>{!deliveryClient && <th className="border border-black p-1 w-20 text-center">Statut</th>}</tr></thead><tbody>{printBLData.items.map((bt, i) => (<tr key={i}><td className="border border-black p-1 text-center font-bold">{bt.id}</td><td className="border border-black p-1 text-center">{bt.pieces ? bt.pieces.reduce((acc,p)=>acc+p.quantity,0) : 1}</td><td className="border border-black p-1">{!deliveryClient && <span className="font-bold text-gray-700 block text-[10px]">{clients.find(c => c.id === bt.clientId)?.name} : </span>}{bt.pieces ? bt.pieces.map(p => (<span key={p.categoryName} className="mr-2"><span className="font-bold">{p.quantity}x {p.categoryName}</span><span className="italic text-[10px]"> ({p.designation})</span><span className="text-[10px] text-gray-600"> : {groupServices(p.services, false).join(', ')}</span></span>)) : '...'}</td>{!deliveryClient && <td className="border border-black p-1 text-center">{bt.status}</td>}</tr>))}</tbody></table><div className="mt-4 text-right text-xl font-bold">Total Pièces : {printBLData.items.reduce((acc, bt) => acc + (bt.pieces ? bt.pieces.reduce((s,p)=>s+p.quantity,0) : 0), 0)}</div></div>)}
              <Card title="Menu Sortie (Livraisons)">
                  <div className="flex flex-col md:flex-row gap-4 items-end"><div className="w-full md:w-1/4 grid grid-cols-2 gap-2"><div><label className="block text-xs font-bold text-gray-500 uppercase mb-1">Du</label><input type="date" className="w-full border-2 border-gray-300 p-2 rounded font-bold text-sm" value={deliveryStart} onChange={e => setDeliveryStart(e.target.value)} /></div><div><label className="block text-xs font-bold text-gray-500 uppercase mb-1">Au</label><input type="date" className="w-full border-2 border-gray-300 p-2 rounded font-bold text-sm" value={deliveryEnd} onChange={e => setDeliveryEnd(e.target.value)} /></div></div><div className="w-full md:w-1/3"><label className="block text-xs font-bold text-gray-500 uppercase mb-1">2. Filtre Magasin</label><div className="flex gap-2"><select className={`w-full border-2 p-3 rounded font-bold text-lg ${deliveryClient ? 'border-blue-100 text-blue-900 bg-white' : 'border-gray-300 text-gray-800 bg-gray-50'}`} value={deliveryClient} onChange={e => setDeliveryClient(e.target.value)}><option value="">TOTAL</option>{clients.map(c => <option key={c.id} value={c.id}>{c.name}</option>)}</select>{deliveryClient && <Button variant="ghost" onClick={() => {setDeliveryClient(''); localStorage.removeItem('lastDeliveryClient')}} title="Voir Total"><RefreshCcw size={20}/></Button>}</div></div><div className="flex-1 w-full relative"><label className="block text-xs font-bold text-purple-600 uppercase mb-1">3. Scan Sortie</label><ScanBarcode className="absolute left-3 top-9 text-purple-400" size={24}/><input ref={scanRef} className="w-full pl-12 p-3 border-2 border-purple-300 rounded text-xl font-mono font-bold focus:ring-4 focus:ring-purple-200 outline-none" placeholder={deliveryClient ? "Bippez le ticket..." : "Mode TOTAL"} value={scanInput} onChange={e => setScanInput(e.target.value)} onKeyDown={(e) => e.key === 'Enter' && validateScan(scanInput)}/></div></div>
              </Card>
              <div className="flex gap-2 border-b border-gray-200 pb-1 items-end">
                  <button onClick={() => setDeliverySubTab('bl')} className={`px-6 py-2 rounded-t-lg font-bold text-sm transition-colors ${deliverySubTab === 'bl' ? 'bg-white border-x border-t border-gray-200 text-green-600' : 'bg-gray-100 text-gray-500 hover:bg-gray-200'}`}><Truck size={16} className="inline mr-2"/> BL en cours</button>
                  <button onClick={() => setDeliverySubTab('planning')} className={`px-6 py-2 rounded-t-lg font-bold text-sm transition-colors ${deliverySubTab === 'planning' ? 'bg-white border-x border-t border-gray-200 text-blue-600' : 'bg-gray-100 text-gray-500 hover:bg-gray-200'}`}><ClipboardList size={16} className="inline mr-2"/> Planning</button>
                  <button onClick={() => setDeliverySubTab('history')} className={`px-6 py-2 rounded-t-lg font-bold text-sm transition-colors ${deliverySubTab === 'history' ? 'bg-white border-x border-t border-gray-200 text-orange-600' : 'bg-gray-100 text-gray-500 hover:bg-gray-200'}`}><History size={16} className="inline mr-2"/> Historique</button>
                  <div className="ml-auto relative"><Search className="absolute left-2 top-2.5 text-gray-400" size={14}/><input className="pl-8 py-1.5 border rounded text-sm w-48 focus:w-64 transition-all" placeholder="Rechercher BT..." value={searchQuery} onChange={e => setSearchQuery(e.target.value)} /></div>
              </div>
              <div className="flex-1 overflow-hidden flex flex-col">
                  {deliverySubTab === 'history' ? (<div className="bg-white rounded-lg shadow-sm border border-gray-200 flex flex-col h-full"><div className="px-6 py-4 border-b bg-gray-50 flex justify-between items-center"><h3 className="font-bold text-gray-700 flex items-center gap-2"><History size={20} className="text-orange-600"/> Historique des BL Validés {deliveryClient ? `pour ${clients.find(c => c.id === deliveryClient)?.name}` : '(Tous)'}</h3></div><div className="flex-1 overflow-y-auto">{blHistory.length === 0 ? <p className="p-8 text-center text-gray-400 italic">Aucun BL archivé.</p> : <table className="w-full text-sm text-left"><thead className="bg-gray-50 text-gray-500 sticky top-0"><tr><th className="p-3 w-8"></th><th className="p-3">Date</th><th className="p-3">N° BL</th><th className="p-3">Magasin</th><th className="p-3 text-center">Nb BT</th><th className="p-3 text-right">CA Total</th><th className="p-3 text-right">Actions</th></tr></thead><tbody className="divide-y">{blHistory.map((bl, i) => (<React.Fragment key={bl.blNumber}><tr className="hover:bg-orange-50 cursor-pointer transition-colors" onClick={() => toggleBL(bl.blNumber)}><td className="p-3 text-gray-400">{expandedBLs.has(bl.blNumber) ? <ChevronDown size={16}/> : <ChevronRight size={16}/>}</td><td className="p-3">{formatDate(bl.date)}</td><td className="p-3 font-bold font-mono">{bl.blNumber}</td><td className="p-3">{bl.clientName}</td><td className="p-3 text-center"><span className="bg-orange-100 text-orange-800 px-2 py-1 rounded-full text-xs font-bold">{bl.items.length}</span></td><td className="p-3 text-right font-bold text-blue-600">{formatPrice(bl.totalAmount)}</td><td className="p-3 text-right"><Button size="sm" variant="outline" onClick={(e) => { e.stopPropagation(); handlePrintBL(bl.items, bl.date, bl.blNumber); }}><Printer size={14}/> Réimprimer</Button></td></tr>{expandedBLs.has(bl.blNumber) && (<tr className="bg-gray-50"><td colSpan="7" className="p-0"><div className="p-4 border-y border-gray-200 shadow-inner"><table className="w-full text-xs bg-white rounded border border-gray-200"><thead className="bg-gray-100 text-gray-500"><tr><th className="p-2 text-left">BT</th><th className="p-2 text-left">Détail Pièces & Services</th><th className="p-2 text-right">Total BT</th></tr></thead><tbody className="divide-y">{bl.items.map(bt => { const btTotal = bt.pieces ? bt.pieces.reduce((accP, p) => accP + p.quantity * p.services.reduce((accS, s) => accS + s.price, 0), 0) : 0; return (<tr key={bt.id}><td className="p-2 font-mono font-bold text-blue-600">{bt.id}</td><td className="p-2">{bt.pieces.map((p, idx) => (<div key={idx} className="mb-1"><span className="font-bold">{p.quantity}x {p.categoryName}</span><span className="text-gray-500 ml-1"> - {groupServices(p.services, false).join(', ')}</span></div>))}</td><td className="p-2 text-right font-medium">{formatPrice(btTotal)}</td></tr>); })}</tbody></table></div></td></tr>)}</React.Fragment>))}</tbody></table>}</div></div>) : (<div className="bg-white rounded-lg shadow-sm border border-gray-200 flex flex-col h-full"><div className="px-6 py-4 border-b bg-gray-50 flex justify-between items-center"><h3 className="font-bold text-gray-700 flex items-center gap-2"><Truck size={20} className="text-green-600"/> {deliveryClient ? (deliverySubTab === 'bl' ? `BL du ${formatDate(deliveryStart)} au ${formatDate(deliveryEnd)}` : `Planning du ${formatDate(deliveryStart)} au ${formatDate(deliveryEnd)}`) : `PLANNING GLOBAL`} <span className="bg-green-100 text-green-800 px-3 py-1 rounded-full text-sm ml-2 border border-green-200 shadow-sm flex items-center gap-2"><span className="font-bold text-lg">{totalPieces}</span> pièces <span className="text-xs text-green-600">({displayedItems.length} tickets)</span></span></h3><Button onClick={() => handlePrintBL()} variant="secondary" disabled={displayedItems.length === 0}><Printer size={16}/> {deliveryClient && deliverySubTab === 'bl' ? 'Imprimer & Valider BL' : 'Imprimer Liste'}</Button></div><div className="flex-1 overflow-y-auto p-0">{displayedItems.length === 0 ? (<div className="h-full flex flex-col items-center justify-center text-gray-300"><Truck size={64} className="mb-4 opacity-20"/><p className="text-lg italic">{deliveryClient ? "Aucun élément." : "Rien de prévu."}</p></div>) : (<table className="w-full text-sm text-left"><thead className="bg-gray-50 text-gray-500 sticky top-0"><tr>{(!deliveryClient || deliverySubTab === 'planning') && <th className="p-3 w-24">Urgence</th>}{(deliveryClient && deliverySubTab === 'bl') && <th className="p-3 w-24">Heure</th>}{!deliveryClient && <th className="p-3 w-32">Magasin</th>}<th className="p-3 w-32">Réf BT</th><th className="p-3">Détail</th>{!deliveryClient && <th className="p-3 text-right">Statut</th>}<th className="p-3 text-right">Actions</th></tr></thead><tbody className="divide-y">{displayedItems.map(bt => { const urgency = getUrgencyStatus(bt.scheduledDeliveryDate); return (<tr key={bt.id} className="hover:bg-green-50 transition-colors">{(!deliveryClient || deliverySubTab === 'planning') && (<td className="p-3"><span className={`px-2 py-1 rounded text-[10px] uppercase ${urgency.color}`}>{urgency.label} ({formatDate(bt.scheduledDeliveryDate)})</span></td>)}{(deliveryClient && deliverySubTab === 'bl') && (<td className="p-3 text-gray-400 font-mono">{bt.dateDelivered ? new Date(bt.dateDelivered).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}) : '-'}</td>)}{!deliveryClient && (<td className="p-3 font-bold text-gray-700">{clients.find(c => c.id === bt.clientId)?.name}</td>)}<td className="p-3 font-bold text-blue-600 font-mono">{bt.id}</td><td className="p-3">{bt.pieces ? bt.pieces.map((p, idx) => (<div key={idx} className="mb-2"><div className="font-bold text-gray-800">{p.quantity}x {p.categoryName}</div><div className="text-xs text-blue-600 pl-2">{groupServices(p.services, false).join(', ')}</div></div>)) : 'Ancien'}</td>{!deliveryClient && (<td className="p-3 text-right"><span className={`px-2 py-1 rounded text-xs font-bold ${bt.status === 'LIVRE' || bt.status === 'BL_EN_COURS' ? 'bg-green-100 text-green-800' : 'bg-yellow-100 text-yellow-800'}`}>{bt.status === 'BL_EN_COURS' ? 'EN BL' : bt.status}</span></td>)}<td className="p-3 text-right flex justify-end gap-2"><Button variant="ghost" onClick={() => openEditModal(bt)} className="text-blue-400 hover:text-blue-600"><Edit2 size={16}/></Button>{bt.status !== 'BL_EN_COURS' && bt.status !== 'LIVRE' && (<Button variant="ghost" onClick={() => validateScan(bt.id)} className="text-green-600 hover:text-green-800 hover:bg-green-50"><CheckCircle size={16}/></Button>)}{(bt.status === 'BL_EN_COURS' || (deliveryClient && bt.status === 'LIVRE')) && (<Button variant="ghost" onClick={() => cancelDelivery(bt.id)} className="text-red-400 hover:text-red-600 hover:bg-red-50"><RotateCcw size={16}/></Button>)}</td></tr>)})}</tbody></table>)}</div></div>)}</div></div>
      );
  };

  const HistoryModule = () => {
    const [filters, setFilters] = useState({ client: '', status: '', start: '', end: '', query: '' });
    const [sortConfig, setSortConfig] = useState({ key: 'dateCreated', direction: 'desc' });
    const [expandedRows, setExpandedRows] = useState(new Set());
    const filtered = useMemo(() => workOrders.filter(bt => { const matchClient = filters.client ? bt.clientId === filters.client : true; const matchStatus = filters.status ? bt.status === filters.status : true; const btDate = new Date(bt.dateCreated).toISOString().split('T')[0]; const matchStart = filters.start ? btDate >= filters.start : true; const matchEnd = filters.end ? btDate <= filters.end : true; const matchQuery = filters.query ? bt.id.toLowerCase().includes(filters.query.toLowerCase()) : true; return matchClient && matchStatus && matchStart && matchEnd && matchQuery; }), [workOrders, filters]);
    const handleSort = (key) => { let direction = 'asc'; if (sortConfig.key === key && sortConfig.direction === 'asc') direction = 'desc'; setSortConfig({ key, direction }); };
    const sortedFiltered = useMemo(() => { let items = [...filtered]; if (sortConfig.key) { items.sort((a, b) => { let aVal = a[sortConfig.key]; let bVal = b[sortConfig.key]; if (sortConfig.key === 'clientName') { aVal = clients.find(c => c.id === a.clientId)?.name || ''; bVal = clients.find(c => c.id === b.clientId)?.name || ''; } if (aVal < bVal) return sortConfig.direction === 'asc' ? -1 : 1; if (aVal > bVal) return sortConfig.direction === 'asc' ? 1 : -1; return 0; }); } return items; }, [filtered, sortConfig, clients]);
    const toggleDetails = (id) => { const newSet = new Set(expandedRows); if (newSet.has(id)) newSet.delete(id); else newSet.add(id); setExpandedRows(newSet); };

    return (
      <Card title="Archives Globales">
          <div className="grid grid-cols-1 md:grid-cols-5 gap-4 mb-4 bg-gray-50 p-4 rounded border items-end"><div><label className="text-xs font-bold block mb-1">Recherche</label><div className="relative"><Search className="absolute left-2 top-2.5 text-gray-400" size={16}/><input className="w-full pl-8 p-2 border rounded" placeholder="BT..." value={filters.query} onChange={e => setFilters({...filters, query: e.target.value})} /></div></div><div><label className="text-xs font-bold block mb-1">Client</label><select className="w-full border p-2 rounded" value={filters.client} onChange={e => setFilters({...filters, client: e.target.value})}><option value="">Tous</option>{clients.map(c => <option key={c.id} value={c.id}>{c.name}</option>)}</select></div><div><label className="text-xs font-bold block mb-1">Statut</label><select className="w-full border p-2 rounded" value={filters.status} onChange={e => setFilters({...filters, status: e.target.value})}><option value="">Tous</option>{['ATELIER', 'A_LIVRER', 'LIVRE', 'FACTURE', 'AVOIR'].map(s => <option key={s} value={s}>{s}</option>)}</select></div><div><label className="text-xs font-bold block mb-1">Du</label><input type="date" className="w-full border p-2 rounded" value={filters.start} onChange={e => setFilters({...filters, start: e.target.value})} /></div><div><label className="text-xs font-bold block mb-1">Au</label><input type="date" className="w-full border p-2 rounded" value={filters.end} onChange={e => setFilters({...filters, end: e.target.value})} /></div></div>
          <div className="overflow-x-auto"><table className="w-full text-sm text-left"><thead className="bg-gray-50 text-gray-500 sticky top-0"><tr><th className="p-2 bg-gray-100">Détails</th><th className="cursor-pointer bg-gray-100 p-2" onClick={() => handleSort('dateCreated')}>Date Arrivée {sortConfig.key === 'dateCreated' && <ArrowUpDown size={14} className="inline"/>}</th><th className="cursor-pointer bg-gray-100 p-2" onClick={() => handleSort('scheduledDeliveryDate')}>Date Prévue</th><th className="cursor-pointer bg-gray-100 p-2" onClick={() => handleSort('dateDelivered')}>Date Envoi</th><th className="cursor-pointer bg-gray-100 p-2" onClick={() => handleSort('id')}>BT</th><th className="cursor-pointer bg-gray-100 p-2" onClick={() => handleSort('clientName')}>Client</th><th className="cursor-pointer bg-gray-100 p-2" onClick={() => handleSort('status')}>Statut</th><th className="p-2 bg-gray-100">Actions</th></tr></thead><tbody className="divide-y">{sortedFiltered.map(bt => (<React.Fragment key={bt.id}><tr className="hover:bg-gray-50"><td className="p-2"><button onClick={() => toggleDetails(bt.id)} className="text-blue-500 hover:text-blue-700">{expandedRows.has(bt.id) ? <EyeOff size={16}/> : <Eye size={16}/>}</button></td><td className="p-2 text-xs">{formatDate(bt.dateCreated)}</td><td className="p-2 text-xs">{formatDate(bt.scheduledDeliveryDate)}</td><td className="p-2 text-xs font-medium text-gray-600">{bt.dateDelivered ? formatDate(bt.dateDelivered) : '-'}</td><td className="p-2 font-bold">#{bt.id}</td><td className="p-2">{clients.find(c=>c.id===bt.clientId)?.name}</td><td className="p-2"><span className="text-xs font-bold px-2 py-1 rounded bg-gray-200">{bt.status}</span></td><td className="p-2 flex gap-1">{bt.status !== 'FACTURE' ? (<><Button variant="ghost" onClick={() => openEditModal(bt)}><Edit2 size={14}/></Button><Button variant="ghost" onClick={(e) => {e.stopPropagation(); deleteBT(bt.id)}}><Trash2 size={14}/></Button></>) : <Lock size={14} className="text-gray-400 m-2"/>}</td></tr>{expandedRows.has(bt.id) && (<tr className="bg-blue-50"><td colSpan="8" className="p-4"><div className="text-xs grid grid-cols-2 gap-4 mb-2"><div><strong>Date Entrée :</strong> {new Date(bt.dateCreated).toLocaleString()}</div><div><strong>Date Sortie (BL) :</strong> {bt.dateDelivered ? new Date(bt.dateDelivered).toLocaleString() : '-'}</div></div><div className="font-bold border-b border-blue-200 mb-2 pb-1">Contenu Détaillé :</div>{bt.pieces ? bt.pieces.map((p, idx) => (<div key={idx} className="mb-2 pl-2 border-l-2 border-blue-400"><div className="font-bold">{p.quantity}x {p.categoryName}</div><div className="text-gray-600 italic">Commentaire : {p.designation || 'Aucun'}</div><ul className="list-disc list-inside pl-2 mt-1">{p.services.map((s, sIdx) => (<li key={sIdx}>{s.name} ({formatPrice(s.price)}) {s.comment && <span className="text-gray-500">- {s.comment}</span>}</li>))}</ul></div>)) : 'Anciennes données'}</td></tr>)}</React.Fragment>))}</tbody></table></div>
      </Card>
    );
  };

  const StatsModule = () => {
    const [serviceSearch, setServiceSearch] = useState('');
    const [hourlyRate, setHourlyRate] = useState(() => localStorage.getItem('stats_hourlyRate') || 30);
    const [serviceTimes, setServiceTimes] = useState(() => JSON.parse(localStorage.getItem('stats_serviceTimes')) || {});
    const [startDate, setStartDate] = useState(new Date(new Date().getFullYear(), new Date().getMonth(), 1).toISOString().slice(0, 10)); 
    const [endDate, setEndDate] = useState(new Date().toISOString().slice(0, 10));

    // Daily profitability
    const [dailyStartDate, setDailyStartDate] = useState(getTodayDate());
    const [dailyEndDate, setDailyEndDate] = useState(getTodayDate());
    const [dailyStaff, setDailyStaff] = useState(() => parseInt(localStorage.getItem('stats_dailyStaff')) || 0); // Persist
    const [dailyHours, setDailyHours] = useState(0);

    // Monthly/Annual
    const [monthlyDate, setMonthlyDate] = useState(getTodayDate().slice(0, 7)); 
    const [monthlyStaff, setMonthlyStaff] = useState(0);
    const [monthlyDays, setMonthlyDays] = useState(22); 
    const [annualYear, setAnnualYear] = useState(new Date().getFullYear().toString());
    const [annualStaff, setAnnualStaff] = useState(0);
    const [annualDays, setAnnualDays] = useState(250); 
    
    // NOUVEAU: Prévision journalière & Réception jour
    const [dailyForecastDate, setDailyForecastDate] = useState(getTodayDate());
    const [receptionDate, setReceptionDate] = useState(getTodayDate());

    useEffect(() => { localStorage.setItem('stats_hourlyRate', hourlyRate); }, [hourlyRate]);
    useEffect(() => { localStorage.setItem('stats_serviceTimes', JSON.stringify(serviceTimes)); }, [serviceTimes]);
    useEffect(() => { localStorage.setItem('stats_dailyStaff', dailyStaff); setDailyHours(dailyStaff * 7); }, [dailyStaff]);

    const calculateForecast = (bts) => {
        let totalRevenue = 0, totalPieces = 0, totalTimeMinutes = 0, typeBreakdown = {}, urgencyBreakdown = { late: 0, today: 0, tomorrow: 0, future: 0 };
        const today = getTodayDate();
        const tomorrow = new Date(); tomorrow.setDate(tomorrow.getDate() + 1); const tomorrowStr = tomorrow.toISOString().split('T')[0];

        bts.forEach(bt => {
            if (bt.pieces) {
                bt.pieces.forEach(p => {
                    totalPieces += p.quantity;
                    typeBreakdown[p.categoryName] = (typeBreakdown[p.categoryName] || 0) + p.quantity;
                    p.services.forEach(s => {
                        totalRevenue += (s.price * p.quantity);
                        if (bt.status === 'ATELIER') totalTimeMinutes += ((serviceTimes[s.name] || 0) * p.quantity);
                    });
                });
            }
            const delivery = bt.scheduledDeliveryDate;
            if (delivery < today) urgencyBreakdown.late++;
            else if (delivery === today) urgencyBreakdown.today++;
            else if (delivery === tomorrowStr) urgencyBreakdown.tomorrow++;
            else urgencyBreakdown.future++;
        });
        return { totalRevenue, totalPieces, totalTimeHours: Math.round(totalTimeMinutes / 60), typeBreakdown, urgencyBreakdown, btCount: bts.length };
    };

    const forecastData = useMemo(() => {
        const pendingBTs = workOrders.filter(bt => ['ATELIER', 'A_LIVRER', 'BL_EN_COURS'].includes(bt.status));
        return calculateForecast(pendingBTs);
    }, [workOrders, serviceTimes]);

    // NOUVEAU : Prévision Journalière spécifique
    const dailyForecastData = useMemo(() => {
        const pendingBTs = workOrders.filter(bt => ['ATELIER', 'A_LIVRER', 'BL_EN_COURS'].includes(bt.status) && bt.scheduledDeliveryDate === dailyForecastDate);
        return calculateForecast(pendingBTs);
    }, [workOrders, serviceTimes, dailyForecastDate]);

    // NOUVEAU : Réception Journalière
    const receptionStats = useMemo(() => {
        const receivedBTs = workOrders.filter(bt => bt.dateCreated.startsWith(receptionDate));
        let pieces = 0, servicesCount = 0;
        receivedBTs.forEach(bt => {
            if(bt.pieces) { bt.pieces.forEach(p => { pieces += p.quantity; servicesCount += (p.services.length * p.quantity); }); }
        });
        return { count: receivedBTs.length, pieces, servicesCount };
    }, [workOrders, receptionDate]);

    const dailyData = useMemo(() => {
        const deliveredToday = workOrders.filter(bt => { if (!bt.dateDelivered) return false; const d = bt.dateDelivered.slice(0, 10); return d >= dailyStartDate && d <= dailyEndDate && ['LIVRE', 'BL_EN_COURS', 'FACTURE'].includes(bt.status); });
        const totalPieces = deliveredToday.reduce((acc, bt) => acc + (bt.pieces ? bt.pieces.reduce((s,p)=>s+p.quantity,0) : 0), 0);
        const totalTurnover = deliveredToday.reduce((acc, bt) => acc + (bt.pieces ? bt.pieces.reduce((accP, p) => accP + p.quantity * p.services.reduce((accS, s) => accS + s.price, 0), 0) : 0), 0);
        const totalCost = dailyHours * hourlyRate; const netMargin = totalTurnover - totalCost; const profitability = totalTurnover > 0 ? (netMargin / totalTurnover) * 100 : 0;
        return { btCount: deliveredToday.length, pieces: totalPieces, turnover: totalTurnover, cost: totalCost, margin: netMargin, percent: profitability };
    }, [workOrders, dailyStartDate, dailyEndDate, dailyHours, hourlyRate]);

    const monthlyData = useMemo(() => {
        const targetMonth = monthlyDate; 
        const deliveredInMonth = workOrders.filter(bt => bt.dateDelivered && bt.dateDelivered.startsWith(targetMonth) && ['LIVRE', 'BL_EN_COURS', 'FACTURE'].includes(bt.status));
        const totalTurnover = deliveredInMonth.reduce((acc, bt) => acc + (bt.pieces ? bt.pieces.reduce((accP, p) => accP + p.quantity * p.services.reduce((accS, s) => accS + s.price, 0), 0) : 0), 0);
        const totalPieces = deliveredInMonth.reduce((acc, bt) => acc + (bt.pieces ? bt.pieces.reduce((s,p)=>s+p.quantity,0) : 0), 0);
        const totalCost = monthlyStaff * 7 * monthlyDays * hourlyRate; const netMargin = totalTurnover - totalCost; const profitability = totalTurnover > 0 ? (netMargin / totalTurnover) * 100 : 0;
        return { btCount: deliveredInMonth.length, pieces: totalPieces, turnover: totalTurnover, cost: totalCost, margin: netMargin, percent: profitability };
    }, [workOrders, monthlyDate, monthlyStaff, monthlyDays, hourlyRate]);

    const annualData = useMemo(() => {
        const targetYear = annualYear; 
        const deliveredInYear = workOrders.filter(bt => bt.dateDelivered && bt.dateDelivered.startsWith(targetYear) && ['LIVRE', 'BL_EN_COURS', 'FACTURE'].includes(bt.status));
        const totalTurnover = deliveredInYear.reduce((acc, bt) => acc + (bt.pieces ? bt.pieces.reduce((accP, p) => accP + p.quantity * p.services.reduce((accS, s) => accS + s.price, 0), 0) : 0), 0);
        const totalPieces = deliveredInYear.reduce((acc, bt) => acc + (bt.pieces ? bt.pieces.reduce((s,p)=>s+p.quantity,0) : 0), 0);
        const totalCost = annualStaff * 7 * annualDays * hourlyRate; const netMargin = totalTurnover - totalCost; const profitability = totalTurnover > 0 ? (netMargin / totalTurnover) * 100 : 0;
        return { btCount: deliveredInYear.length, pieces: totalPieces, turnover: totalTurnover, cost: totalCost, margin: netMargin, percent: profitability };
    }, [workOrders, annualYear, annualStaff, annualDays, hourlyRate]);

    const serviceStats = useMemo(() => {
        const data = {};
        const filtered = workOrders.filter(bt => { const d = new Date(bt.dateCreated).toISOString().slice(0, 10); return d >= startDate && d <= endDate && bt.status !== 'AVOIR'; });
        filtered.forEach(bt => { if(bt.pieces) { bt.pieces.forEach(p => { p.services.forEach(s => { const name = s.name; if(!data[name]) { data[name] = { count: 0, revenue: 0 }; } data[name].count += p.quantity; data[name].revenue += (s.price * p.quantity); }); }); } });
        let statsArray = Object.keys(data).map(name => { const item = data[name]; const avgPrice = item.count ? item.revenue / item.count : 0; const time = serviceTimes[name] || 0; const cost = time > 0 ? (time / 60) * hourlyRate : 0; const margin = avgPrice - cost; const marginRate = avgPrice > 0 ? (margin / avgPrice) * 100 : 0; return { name, count: item.count, revenue: item.revenue, avgPrice, time, cost, margin, marginRate }; });
        const totalAvg = { name: "TOTAL MOYEN", count: statsArray.length > 0 ? statsArray.reduce((acc, s) => acc + s.count, 0) / statsArray.length : 0, revenue: statsArray.length > 0 ? statsArray.reduce((acc, s) => acc + s.revenue, 0) / statsArray.length : 0, avgPrice: statsArray.length > 0 ? statsArray.reduce((acc, s) => acc + s.avgPrice, 0) / statsArray.length : 0, time: statsArray.length > 0 ? statsArray.reduce((acc, s) => acc + s.time, 0) / statsArray.length : 0, cost: statsArray.length > 0 ? statsArray.reduce((acc, s) => acc + s.cost, 0) / statsArray.length : 0, margin: statsArray.length > 0 ? statsArray.reduce((acc, s) => acc + s.margin, 0) / statsArray.length : 0, marginRate: statsArray.length > 0 ? statsArray.reduce((acc, s) => acc + s.marginRate, 0) / statsArray.length : 0, isTotal: true };
        if (serviceSearch) { statsArray = statsArray.filter(s => s.name.toLowerCase().includes(serviceSearch.toLowerCase())); }
        const sorted = statsArray.sort((a,b) => b.revenue - a.revenue); 
        return sorted.length > 0 ? [totalAvg, ...sorted] : [];
    }, [workOrders, serviceSearch, hourlyRate, serviceTimes, startDate, endDate]);

    const updateServiceTime = (name, val) => { const time = parseFloat(val) || 0; setServiceTimes(prev => ({...prev, [name]: time})); };

    return (
        <div className="space-y-6">
            <h2 className="text-2xl font-bold text-gray-800">Rentabilité & Performance</h2>
            <Card title="Section : Prévision GLOBALE (Charge de travail & CA en attente)">
                <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
                    <div className="space-y-4">
                        <div className="p-4 bg-gradient-to-br from-blue-500 to-blue-700 rounded-lg text-white shadow-md"><div className="flex items-center gap-2 text-blue-100 text-xs font-bold uppercase mb-1"><TrendingUp size={14}/> CA Prévisionnel (BT non livrés)</div><div className="text-3xl font-black">{formatPrice(forecastData.totalRevenue)}</div><div className="text-xs text-blue-100 mt-1 opacity-80">Trésorerie engagée dans {forecastData.btCount} bons.</div></div>
                        <div className="p-4 bg-white border-2 border-orange-100 rounded-lg shadow-sm"><div className="flex items-center gap-2 text-orange-600 text-xs font-bold uppercase mb-1"><Hourglass size={14}/> Charge de travail restante</div><div className="flex justify-between items-end"><div><div className="text-2xl font-black text-gray-800">{forecastData.totalPieces} pièces</div><div className="text-xs text-gray-400">À traiter dans l'atelier</div></div><div className="text-right"><div className="text-xl font-bold text-orange-600">~ {forecastData.totalTimeHours}h</div><div className="text-[10px] text-gray-400">Estimé</div></div></div></div>
                    </div>
                    <div className="bg-gray-50 rounded-lg p-4 border border-gray-200"><div className="text-xs font-bold text-gray-500 uppercase mb-3 flex items-center gap-2"><Layers size={14}/> Types de pièces à faire</div><div className="space-y-2 max-h-32 overflow-y-auto pr-1">{Object.entries(forecastData.typeBreakdown).length > 0 ? (Object.entries(forecastData.typeBreakdown).sort((a,b) => b[1] - a[1]).map(([type, count]) => (<div key={type} className="flex justify-between items-center bg-white p-2 rounded border border-gray-100 shadow-sm"><span className="text-sm font-medium text-gray-700">{type}</span><span className="bg-blue-100 text-blue-800 px-2 py-0.5 rounded-full text-xs font-bold">{count}</span></div>))) : <div className="text-center text-gray-400 italic text-sm py-4">Aucune pièce en attente</div>}</div></div>
                    <div className="bg-white rounded-lg p-4 border border-gray-200"><div className="text-xs font-bold text-gray-500 uppercase mb-3 flex items-center gap-2"><AlertTriangle size={14}/> Analyse des Urgences</div><div className="grid grid-cols-2 gap-2"><div className={`p-2 rounded border flex flex-col items-center justify-center ${forecastData.urgencyBreakdown.late > 0 ? 'bg-red-50 border-red-200' : 'bg-gray-50 border-gray-100 opacity-50'}`}><div className="text-xl font-black text-red-600">{forecastData.urgencyBreakdown.late}</div><div className="text-[10px] font-bold text-red-800 uppercase">Retard</div></div><div className={`p-2 rounded border flex flex-col items-center justify-center ${forecastData.urgencyBreakdown.today > 0 ? 'bg-purple-50 border-purple-200' : 'bg-gray-50 border-gray-100 opacity-50'}`}><div className="text-xl font-black text-purple-600">{forecastData.urgencyBreakdown.today}</div><div className="text-[10px] font-bold text-purple-800 uppercase">Auj.</div></div><div className={`p-2 rounded border flex flex-col items-center justify-center ${forecastData.urgencyBreakdown.tomorrow > 0 ? 'bg-orange-50 border-orange-200' : 'bg-gray-50 border-gray-100 opacity-50'}`}><div className="text-xl font-black text-orange-600">{forecastData.urgencyBreakdown.tomorrow}</div><div className="text-[10px] font-bold text-orange-800 uppercase">Demain</div></div><div className="p-2 bg-blue-50 border border-blue-100 rounded flex flex-col items-center justify-center"><div className="text-xl font-black text-blue-600">{forecastData.urgencyBreakdown.future}</div><div className="text-[10px] font-bold text-blue-800 uppercase">À venir</div></div></div></div>
                </div>
            </Card>

            <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                <Card title="Prévision JOURNALIÈRE">
                    <div className="mb-4"><label className="block text-xs font-bold text-gray-500 uppercase mb-1">Date analysée</label><input type="date" className="w-full border p-2 rounded" value={dailyForecastDate} onChange={e => setDailyForecastDate(e.target.value)} /></div>
                    <div className="space-y-4">
                        <div className="p-4 bg-white border rounded-lg shadow-sm flex justify-between items-center"><div><div className="text-sm font-bold text-gray-600">CA à faire</div><div className="text-2xl font-black text-blue-600">{formatPrice(dailyForecastData.totalRevenue)}</div></div><div><div className="text-sm font-bold text-gray-600 text-right">Tickets</div><div className="text-xl font-black text-blue-800 text-right">{dailyForecastData.btCount}</div></div></div>
                        <div className="p-4 bg-gray-50 border rounded-lg shadow-sm flex justify-between items-center"><div><div className="text-sm font-bold text-gray-600">Pièces</div><div className="text-2xl font-black text-gray-800">{dailyForecastData.totalPieces}</div></div><div className="text-right"><div className="text-sm font-bold text-gray-600">Charge (h)</div><div className="text-xl font-black text-orange-600">~ {dailyForecastData.totalTimeHours}h</div></div></div>
                    </div>
                </Card>
                <Card title="Réception JOURNALIÈRE">
                    <div className="mb-4"><label className="block text-xs font-bold text-gray-500 uppercase mb-1">Date analysée</label><input type="date" className="w-full border p-2 rounded" value={receptionDate} onChange={e => setReceptionDate(e.target.value)} /></div>
                    <div className="p-4 bg-green-50 border border-green-200 rounded-lg shadow-sm flex flex-col justify-center h-40">
                         <div className="flex justify-between items-center mb-2"><span className="font-bold text-green-800">Bons créés</span><span className="text-2xl font-black text-green-900">{receptionStats.count}</span></div>
                         <div className="flex justify-between items-center mb-2"><span className="font-bold text-green-800">Pièces reçues</span><span className="text-2xl font-black text-green-900">{receptionStats.pieces}</span></div>
                         <div className="flex justify-between items-center"><span className="font-bold text-green-800">Services à faire</span><span className="text-2xl font-black text-green-900">{receptionStats.servicesCount}</span></div>
                    </div>
                </Card>
            </div>

            <Card title="Rentabilité Journalière (ou Période courte)">
                <div className="flex flex-col md:flex-row gap-6">
                    <div className="w-full md:w-1/3 space-y-4">
                        <div className="grid grid-cols-2 gap-2"><div><label className="block text-xs font-bold text-gray-500 uppercase mb-1">Du</label><input type="date" className="w-full border p-2 rounded" value={dailyStartDate} onChange={e => setDailyStartDate(e.target.value)} /></div><div><label className="block text-xs font-bold text-gray-500 uppercase mb-1">Au</label><input type="date" className="w-full border p-2 rounded" value={dailyEndDate} onChange={e => setDailyEndDate(e.target.value)} /></div></div>
                        <div className="grid grid-cols-2 gap-4"><div><label className="block text-xs font-bold text-gray-500 uppercase mb-1">Effectif (Pers.)</label><input type="number" className="w-full border p-2 rounded" value={dailyStaff} onChange={e => setDailyStaff(parseInt(e.target.value) || 0)} placeholder="0" /></div><div><label className="block text-xs font-bold text-gray-500 uppercase mb-1">Heures (Auto)</label><input type="number" className="w-full border p-2 rounded bg-gray-50" value={dailyHours} onChange={e => setDailyHours(parseFloat(e.target.value) || 0)} placeholder="0" /></div></div>
                        <div><label className="block text-xs font-bold text-purple-600 uppercase mb-1">Taux Horaire (€/h)</label><input type="number" className="w-full border-2 border-purple-200 p-2 rounded font-bold text-purple-900" value={hourlyRate} onChange={e => setHourlyRate(e.target.value)} /></div>
                    </div>
                    <div className="w-full md:w-2/3 bg-gray-50 rounded p-4 border flex flex-col justify-center">
                        <div className="grid grid-cols-2 md:grid-cols-4 gap-4 text-center mb-6"><div className="p-2 bg-white rounded shadow-sm"><div className="text-xs text-gray-500 uppercase font-bold">Livrés</div><div className="text-xl font-bold text-blue-600">{dailyData.btCount}</div></div><div className="p-2 bg-white rounded shadow-sm"><div className="text-xs text-gray-500 uppercase font-bold">Pièces</div><div className="text-xl font-bold text-blue-600">{dailyData.pieces}</div></div><div className="p-2 bg-white rounded shadow-sm"><div className="text-xs text-gray-500 uppercase font-bold">CA</div><div className="text-xl font-bold text-green-600">{formatPrice(dailyData.turnover)}</div></div><div className="p-2 bg-white rounded shadow-sm"><div className="text-xs text-gray-500 uppercase font-bold">Coût</div><div className="text-xl font-bold text-red-400">{formatPrice(dailyData.cost)}</div></div></div>
                        <div className="border-t pt-4"><div className="flex justify-between items-end"><div><div className="text-sm font-bold text-gray-600">Marge Nette</div><div className={`text-4xl font-black ${dailyData.margin >= 0 ? 'text-green-600' : 'text-red-600'}`}>{formatPrice(dailyData.margin)}</div></div><div className="text-right"><div className="text-sm font-bold text-gray-600">Rentabilité</div><div className={`text-3xl font-black ${dailyData.percent > 20 ? 'text-green-500' : dailyData.percent > 0 ? 'text-orange-400' : 'text-red-500'}`}>{Math.round(dailyData.percent)}%</div></div></div></div>
                    </div>
                </div>
            </Card>

            <Card title="Rentabilité Mensuelle">
                <div className="flex flex-col md:flex-row gap-6">
                    <div className="w-full md:w-1/3 space-y-4"><div><label className="block text-xs font-bold text-gray-500 uppercase mb-1">Mois analysé</label><input type="month" className="w-full border p-2 rounded" value={monthlyDate} onChange={e => setMonthlyDate(e.target.value)} /></div><div className="grid grid-cols-2 gap-4"><div><label className="block text-xs font-bold text-gray-500 uppercase mb-1">Effectif Moyen</label><input type="number" className="w-full border p-2 rounded" value={monthlyStaff} onChange={e => setMonthlyStaff(parseInt(e.target.value) || 0)} placeholder="0" /></div><div><label className="block text-xs font-bold text-gray-500 uppercase mb-1">Jours Ouvrés</label><input type="number" className="w-full border p-2 rounded" value={monthlyDays} onChange={e => setMonthlyDays(parseInt(e.target.value) || 0)} placeholder="22" /></div></div><div className="text-xs text-gray-500 italic">Base calcul : 7h / jour / personne</div></div>
                    <div className="w-full md:w-2/3 bg-blue-50 rounded p-4 border flex flex-col justify-center">
                        <div className="grid grid-cols-2 md:grid-cols-4 gap-4 text-center mb-6"><div className="p-2 bg-white rounded shadow-sm"><div className="text-xs text-gray-500 uppercase font-bold">Livrés</div><div className="text-xl font-bold text-blue-600">{monthlyData.btCount}</div></div><div className="p-2 bg-white rounded shadow-sm"><div className="text-xs text-gray-500 uppercase font-bold">Pièces</div><div className="text-xl font-bold text-blue-600">{monthlyData.pieces}</div></div><div className="p-2 bg-white rounded shadow-sm"><div className="text-xs text-gray-500 uppercase font-bold">CA</div><div className="text-xl font-bold text-green-600">{formatPrice(monthlyData.turnover)}</div></div><div className="p-2 bg-white rounded shadow-sm"><div className="text-xs text-gray-500 uppercase font-bold">Coût</div><div className="text-xl font-bold text-red-400">{formatPrice(monthlyData.cost)}</div></div></div>
                        <div className="border-t pt-4 border-blue-200"><div className="flex justify-between items-end"><div><div className="text-sm font-bold text-gray-600">Marge Nette</div><div className={`text-4xl font-black ${monthlyData.margin >= 0 ? 'text-green-600' : 'text-red-600'}`}>{formatPrice(monthlyData.margin)}</div></div><div className="text-right"><div className="text-sm font-bold text-gray-600">Rentabilité</div><div className={`text-3xl font-black ${monthlyData.percent > 20 ? 'text-green-500' : monthlyData.percent > 0 ? 'text-orange-400' : 'text-red-500'}`}>{Math.round(monthlyData.percent)}%</div></div></div></div>
                    </div>
                </div>
            </Card>

            <Card title="Rentabilité Annuelle">
                <div className="flex flex-col md:flex-row gap-6">
                    <div className="w-full md:w-1/3 space-y-4"><div><label className="block text-xs font-bold text-gray-500 uppercase mb-1">Année analysée</label><input type="number" className="w-full border p-2 rounded" value={annualYear} onChange={e => setAnnualYear(e.target.value)} /></div><div className="grid grid-cols-2 gap-4"><div><label className="block text-xs font-bold text-gray-500 uppercase mb-1">Effectif Moyen</label><input type="number" className="w-full border p-2 rounded" value={annualStaff} onChange={e => setAnnualStaff(parseInt(e.target.value) || 0)} placeholder="0" /></div><div><label className="block text-xs font-bold text-gray-500 uppercase mb-1">Jours Ouvrés</label><input type="number" className="w-full border p-2 rounded" value={annualDays} onChange={e => setAnnualDays(parseInt(e.target.value) || 0)} placeholder="250" /></div></div><div className="text-xs text-gray-500 italic">Base calcul : 7h / jour / personne</div></div>
                    <div className="w-full md:w-2/3 bg-orange-50 rounded p-4 border flex flex-col justify-center">
                        <div className="grid grid-cols-2 md:grid-cols-4 gap-4 text-center mb-6"><div className="p-2 bg-white rounded shadow-sm"><div className="text-xs text-gray-500 uppercase font-bold">Livrés</div><div className="text-xl font-bold text-blue-600">{annualData.btCount}</div></div><div className="p-2 bg-white rounded shadow-sm"><div className="text-xs text-gray-500 uppercase font-bold">Pièces</div><div className="text-xl font-bold text-blue-600">{annualData.pieces}</div></div><div className="p-2 bg-white rounded shadow-sm"><div className="text-xs text-gray-500 uppercase font-bold">CA</div><div className="text-xl font-bold text-green-600">{formatPrice(annualData.turnover)}</div></div><div className="p-2 bg-white rounded shadow-sm"><div className="text-xs text-gray-500 uppercase font-bold">Coût</div><div className="text-xl font-bold text-red-400">{formatPrice(annualData.cost)}</div></div></div>
                        <div className="border-t pt-4 border-orange-200"><div className="flex justify-between items-end"><div><div className="text-sm font-bold text-gray-600">Marge Nette</div><div className={`text-4xl font-black ${annualData.margin >= 0 ? 'text-green-600' : 'text-red-600'}`}>{formatPrice(annualData.margin)}</div></div><div className="text-right"><div className="text-sm font-bold text-gray-600">Rentabilité</div><div className={`text-3xl font-black ${annualData.percent > 20 ? 'text-green-500' : annualData.percent > 0 ? 'text-orange-400' : 'text-red-500'}`}>{Math.round(annualData.percent)}%</div></div></div></div>
                    </div>
                </div>
            </Card>

            <Card title="Paramètres d'Analyse">
                <div className="grid grid-cols-1 md:grid-cols-4 gap-4 items-end"><div><label className="text-xs font-bold text-gray-500 uppercase mb-1">Du</label><input type="date" className="w-full border p-2 rounded" value={startDate} onChange={e => setStartDate(e.target.value)} /></div><div><label className="text-xs font-bold text-gray-500 uppercase mb-1">Au</label><input type="date" className="w-full border p-2 rounded" value={endDate} onChange={e => setEndDate(e.target.value)} /></div><div><label className="text-xs font-bold text-purple-600 uppercase mb-1">Coût Horaire (€/h)</label><div className="flex items-center"><input type="number" className="w-full border-2 border-purple-200 p-2 rounded font-bold text-purple-900" value={hourlyRate} onChange={e => setHourlyRate(e.target.value)} /><span className="ml-2 text-purple-600 font-bold">€</span></div></div><div><label className="text-xs font-bold text-gray-500 uppercase mb-1">Rechercher</label><div className="relative"><Search className="absolute left-2 top-2.5 text-gray-400" size={16}/><input className="w-full pl-8 p-2 border rounded" placeholder="Ourlet, Zip..." value={serviceSearch} onChange={e => setServiceSearch(e.target.value)} /></div></div></div>
            </Card>
            <div className="bg-white rounded-lg shadow overflow-hidden border border-gray-200"><table className="w-full text-sm"><thead className="bg-gray-50 text-gray-700"><tr><th className="p-3 text-left">Prestation</th><th className="p-3 text-center">Qté</th><th className="p-3 text-right">CA Total</th><th className="p-3 text-right text-blue-600">Prix Moy.</th><th className="p-3 text-center bg-yellow-50 w-32">Tps (min)</th><th className="p-3 text-right text-gray-500">Coût</th><th className="p-3 text-right font-bold text-green-700">Marge</th><th className="p-3 text-right">Rentabilité</th></tr></thead><tbody className="divide-y">{serviceStats.map((stat, idx) => (<tr key={idx} className={stat.isTotal ? "bg-gray-100 font-bold border-b-2 border-gray-300" : "hover:bg-gray-50"}><td className="p-3">{stat.name}</td><td className="p-3 text-center">{stat.isTotal ? Math.round(stat.count) : <span className="bg-gray-100 px-2 py-1 rounded text-xs font-bold">{stat.count}</span>}</td><td className="p-3 text-right">{formatPrice(stat.revenue)}</td><td className="p-3 text-right text-blue-600">{formatPrice(stat.avgPrice)}</td><td className={`p-3 text-center ${stat.isTotal ? '' : 'bg-yellow-50'}`}>{stat.isTotal ? Math.round(stat.time) : (<input className="w-16 border border-yellow-200 p-1 rounded text-center text-sm focus:ring-2 ring-yellow-400 outline-none" type="number" placeholder="0" value={serviceTimes[stat.name] || ''} onChange={(e) => updateServiceTime(stat.name, e.target.value)}/>)}</td><td className="p-3 text-right text-gray-500 text-xs">{formatPrice(stat.cost)}</td><td className={`p-3 text-right ${stat.margin >= 0 ? 'text-green-600' : 'text-red-600'}`}>{formatPrice(stat.margin)}</td><td className="p-3 text-right">{(stat.time > 0 || stat.isTotal) ? (<div className="flex items-center justify-end gap-1"><div className={`w-2 h-2 rounded-full ${stat.marginRate > 50 ? 'bg-green-500' : stat.marginRate > 20 ? 'bg-orange-400' : 'bg-red-500'}`}></div><span className="text-xs font-bold">{Math.round(stat.marginRate)}%</span></div>) : <span className="text-gray-300 text-xs">-</span>}</td></tr>))}{serviceStats.length === 0 && <tr><td colSpan="8" className="p-8 text-center text-gray-400 italic">Aucune donnée.</td></tr>}</tbody></table></div>
        </div>
    );
  };

  const ConfigModule = () => {
      const [newCat, setNewCat] = useState('');
      const [newClient, setNewClient] = useState({ name: '', email: '', address: '', siret: '', tva: '', isHeadquarters: false, headquartersId: '' });
      const [newService, setNewService] = useState({ name: '', price: '', catId: '' });
      const [newSpecific, setNewSpecific] = useState({ clientId: '', serviceId: '', price: '' });
      const [newPass, setNewPass] = useState('');
      const [infoForm, setInfoForm] = useState(companyInfo);
      const [editClient, setEditClient] = useState(null); 

      const addCategory = () => { if(newCat) { setCategories([...categories, {id: generateId(), name: newCat}]); setNewCat(''); } };
      const addClient = () => { if(newClient.name) { setClients([...clients, {id: generateId(), ...newClient}]); setNewClient({name:'', email:'', address:'', siret:'', tva:'', isHeadquarters: false, headquartersId: ''}); } };
      const updateClient = () => { if(editClient && editClient.name) { setClients(clients.map(c => c.id === editClient.id ? editClient : c)); setEditClient(null); showToast("Client modifié"); } };
      const addService = () => { if(newService.name && newService.price && newService.catId) { setServices([...services, {id: generateId(), categoryId: newService.catId, name: newService.name, standardPrice: parseFloat(newService.price)}]); setNewService({name:'', price:'', catId:''}); } };
      const addSpecificPrice = () => { if(newSpecific.clientId && newSpecific.serviceId && newSpecific.price) { const others = specificPrices.filter(sp => !(sp.clientId === newSpecific.clientId && sp.serviceId === newSpecific.serviceId)); setSpecificPrices([...others, {id: generateId(), clientId: newSpecific.clientId, serviceId: newSpecific.serviceId, price: parseFloat(newSpecific.price)}]); setNewSpecific({clientId:'', serviceId:'', price:''}); } };
      const updatePassword = () => { if(newPass) { setAdminPassword(newPass); showToast("Mot de passe mis à jour"); setNewPass(''); } };
      const saveCompanyInfo = () => { setCompanyInfo(infoForm); showToast("Infos entreprise enregistrées"); };
      const handleExportData = () => { const data = { timestamp: new Date().toISOString(), clients, categories, services, specificPrices, workOrders, companyInfo }; const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' }); const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href = url; a.download = `backup_retoucherie_${new Date().toISOString().slice(0, 10)}.json`; a.click(); URL.revokeObjectURL(url); };
      const handleImportData = (event) => { const file = event.target.files[0]; if (!file) return; if(!window.confirm("Remplacer TOUTES les données ?")) return; const reader = new FileReader(); reader.onload = (e) => { try { const data = JSON.parse(e.target.result); if (data.clients && data.services) { setClients(data.clients); setCategories(data.categories || []); setServices(data.services); setSpecificPrices(data.specificPrices || []); setWorkOrders(data.workOrders || []); setCompanyInfo(data.companyInfo || companyInfo); showToast("Restauré !"); } else { showToast("Fichier invalide", 'error'); } } catch (err) { showToast("Erreur lecture", 'error'); } }; reader.readAsText(file); };

      return (
          <div className="space-y-6">
              <div className="flex justify-between items-center mb-4"><h2 className="text-xl font-bold">Configuration Admin</h2><div className="flex gap-2"><Button variant="magic" onClick={handleExportData}><Download size={16}/> Backup</Button><label className="flex items-center gap-2 px-4 py-2 bg-white border border-gray-300 rounded cursor-pointer hover:bg-gray-50"><Upload size={16}/> Restore <input type="file" className="hidden" accept=".json" onChange={handleImportData}/></label><Button variant="danger" onClick={() => setIsAuthenticated(false)}><LogOut size={16}/></Button></div></div>
              {editClient && ( <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-[10000] p-4"><div className="bg-white p-6 rounded shadow-xl w-full max-w-lg"><h3 className="font-bold text-lg mb-4">Modifier {editClient.name}</h3><div className="space-y-3 h-[60vh] overflow-y-auto"><input className="w-full border p-2 rounded" placeholder="Nom" value={editClient.name} onChange={e => setEditClient({...editClient, name: e.target.value})} /><input className="w-full border p-2 rounded" placeholder="Email" value={editClient.email} onChange={e => setEditClient({...editClient, email: e.target.value})} /><input className="w-full border p-2 rounded" placeholder="Adresse" value={editClient.address} onChange={e => setEditClient({...editClient, address: e.target.value})} /><input className="w-full border p-2 rounded" placeholder="SIRET" value={editClient.siret} onChange={e => setEditClient({...editClient, siret: e.target.value})} /><input className="w-full border p-2 rounded" placeholder="TVA" value={editClient.tva} onChange={e => setEditClient({...editClient, tva: e.target.value})} /><div className="bg-orange-50 p-2 rounded border border-orange-100"><div className="flex items-center gap-2 mb-2"><input type="checkbox" id="editIsHQ" checked={editClient.isHeadquarters || false} onChange={e => setEditClient({...editClient, isHeadquarters: e.target.checked, headquartersId: ''})} /><label htmlFor="editIsHQ" className="text-sm font-bold text-orange-800">Est un Siège Gestionnaire ?</label></div>{!editClient.isHeadquarters && (<div><label className="text-xs font-bold text-gray-500 block mb-1">Rattaché au Siège :</label><select className="w-full border p-2 rounded text-sm" value={editClient.headquartersId || ''} onChange={e => setEditClient({...editClient, headquartersId: e.target.value})}><option value="">-- Aucun --</option>{clients.filter(c => c.isHeadquarters && c.id !== editClient.id).map(hq => (<option key={hq.id} value={hq.id}>{hq.name}</option>))}</select></div>)}</div><div className="flex items-center gap-2 bg-gray-50 p-2 rounded"><input type="checkbox" id="editAuto" checked={editClient.autoGenerateBt || false} onChange={e => setEditClient({...editClient, autoGenerateBt: e.target.checked})} /><label htmlFor="editAuto" className="text-sm font-bold">Génération Auto BT ?</label></div>{editClient.autoGenerateBt && (<div className="flex gap-2"><input className="w-full border p-2 rounded" placeholder="Préfixe (ex: CLR)" value={editClient.btPrefix || ''} onChange={e => setEditClient({...editClient, btPrefix: e.target.value})} /><input type="number" className="w-24 border p-2 rounded" placeholder="Compteur" value={editClient.nextBtSequence || 1} onChange={e => setEditClient({...editClient, nextBtSequence: parseInt(e.target.value)})} /></div>)}</div><div className="flex justify-end gap-2 mt-4 pt-4 border-t"><Button variant="outline" onClick={() => setEditClient(null)}>Annuler</Button><Button onClick={updateClient}>Enregistrer</Button></div></div></div> )}
              <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                  <Card title="Information Entreprise"><div className="space-y-2"><input className="w-full border p-2 rounded" placeholder="Nom de la retoucherie" value={infoForm.name} onChange={e => setInfoForm({...infoForm, name: e.target.value})} /><input className="w-full border p-2 rounded" placeholder="Adresse complète" value={infoForm.address} onChange={e => setInfoForm({...infoForm, address: e.target.value})} /><input className="w-full border p-2 rounded" placeholder="SIRET / RCS" value={infoForm.siret} onChange={e => setInfoForm({...infoForm, siret: e.target.value})} /><input className="w-full border p-2 rounded" placeholder="Pied de page" value={infoForm.footer} onChange={e => setInfoForm({...infoForm, footer: e.target.value})} /><Button onClick={saveCompanyInfo} variant="success">Enregistrer les infos</Button></div></Card>
                  <Card title="Gestion des Clients">
                      <div className="flex flex-col gap-2 mb-4 bg-blue-50 p-2 rounded border border-blue-100"><div className="flex gap-2"><input className="border p-2 rounded flex-1" placeholder="Nom Boutique *" value={newClient.name} onChange={e => setNewClient({...newClient, name: e.target.value})} /><input className="border p-2 rounded flex-1" placeholder="Email" value={newClient.email} onChange={e => setNewClient({...newClient, email: e.target.value})} /></div><input className="border p-2 rounded w-full" placeholder="Adresse" value={newClient.address} onChange={e => setNewClient({...newClient, address: e.target.value})} /><div className="flex gap-2"><input className="border p-2 rounded flex-1" placeholder="SIRET" value={newClient.siret} onChange={e => setNewClient({...newClient, siret: e.target.value})} /><input className="border p-2 rounded flex-1" placeholder="N° TVA" value={newClient.tva} onChange={e => setNewClient({...newClient, tva: e.target.value})} /></div><div className="bg-white p-2 rounded border border-blue-200 mt-2"><div className="flex items-center gap-2 mb-2"><input type="checkbox" id="newIsHQ" checked={newClient.isHeadquarters || false} onChange={e => setNewClient({...newClient, isHeadquarters: e.target.checked, headquartersId: ''})} /><label htmlFor="newIsHQ" className="text-sm font-bold text-blue-800">Est un Siège Gestionnaire ?</label></div>{!newClient.isHeadquarters && (<div><label className="text-xs font-bold text-gray-500 block mb-1">Rattaché au Siège :</label><select className="w-full border p-2 rounded text-sm" value={newClient.headquartersId || ''} onChange={e => setNewClient({...newClient, headquartersId: e.target.value})}><option value="">-- Aucun --</option>{clients.filter(c => c.isHeadquarters).map(hq => (<option key={hq.id} value={hq.id}>{hq.name}</option>))}</select></div>)}</div><div className="flex items-center gap-2 mt-2 border-t pt-2 border-blue-200"><input type="checkbox" id="newAuto" checked={newClient.autoGenerateBt || false} onChange={e => setNewClient({...newClient, autoGenerateBt: e.target.checked})} /><label htmlFor="newAuto" className="text-sm font-bold text-blue-800">Génération Auto BT ?</label></div>{newClient.autoGenerateBt && (<div className="flex gap-2 animate-in fade-in slide-in-from-top-1"><input className="border p-2 rounded flex-1" placeholder="Préfixe (ex: CLR)" value={newClient.btPrefix || ''} onChange={e => setNewClient({...newClient, btPrefix: e.target.value})} /><input type="number" className="border p-2 rounded w-24" placeholder="Compteur" value={newClient.nextBtSequence || 1} onChange={e => setNewClient({...newClient, nextBtSequence: parseInt(e.target.value)})} /></div>)}<Button onClick={addClient} className="w-full justify-center mt-2"><Plus size={16}/> Ajouter le client</Button></div>
                      <ul className="space-y-2 max-h-40 overflow-y-auto">{clients.map(c => (<li key={c.id} className="flex justify-between items-center border-b pb-1"><div className="flex-1"><div className="font-bold flex items-center gap-2">{c.name} {c.isHeadquarters && <span className="bg-orange-100 text-orange-800 text-[10px] px-1 rounded border border-orange-200">SIÈGE</span>} {c.headquartersId && <span className="bg-gray-100 text-gray-600 text-[10px] px-1 rounded border">lié à {clients.find(h=>h.id===c.headquartersId)?.name}</span>}</div><div className="text-xs text-gray-500">{c.email}{c.autoGenerateBt && <span className="ml-2 text-purple-600 font-bold">AUTO: {c.btPrefix}{c.nextBtSequence}</span>}</div></div><div className="flex gap-1"><button onClick={() => setEditClient(c)} className="text-blue-500 hover:text-blue-700 p-1"><Edit2 size={16}/></button><button onClick={() => setClients(clients.filter(x => x.id !== c.id))} className="text-red-400 hover:text-red-600 p-1"><Trash2 size={16}/></button></div></li>))}</ul>
                  </Card>
                  <Card title="Tarifs Négociés"><div className="flex flex-col gap-2 mb-4 bg-yellow-50 p-2 rounded"><select className="border p-2 rounded" value={newSpecific.clientId} onChange={e => setNewSpecific({...newSpecific, clientId: e.target.value})}><option value="">Client (ou Siège)...</option>{clients.map(c => <option key={c.id} value={c.id}>{c.name} {c.isHeadquarters ? '(Siège)' : ''}</option>)}</select><select className="border p-2 rounded" value={newSpecific.serviceId} onChange={e => setNewSpecific({...newSpecific, serviceId: e.target.value})}><option value="">Service...</option>{services.map(s => <option key={s.id} value={s.id}>{s.name} ({s.standardPrice}€)</option>)}</select><div className="flex gap-2"><input type="number" className="border p-2 rounded flex-1" placeholder="Nouveau Prix" value={newSpecific.price} onChange={e => setNewSpecific({...newSpecific, price: e.target.value})} /><Button onClick={addSpecificPrice}><Plus size={16}/></Button></div></div><ul className="space-y-2 max-h-40 overflow-y-auto">{specificPrices.map(sp => <li key={sp.id} className="flex justify-between border-b text-xs pb-1"><span>{clients.find(c=>c.id===sp.clientId)?.name} - {services.find(s=>s.id===sp.serviceId)?.name}</span><span className="font-bold">{sp.price}€</span><button onClick={() => setSpecificPrices(specificPrices.filter(x => x.id !== sp.id))} className="text-red-400"><Trash2 size={12}/></button></li>)}</ul></Card>
                  <Card title="Catalogue"><div className="flex gap-2 mb-4"><input className="border p-2 rounded flex-1" placeholder="Nouvelle catégorie" value={newCat} onChange={e => setNewCat(e.target.value)} /><Button onClick={addCategory}><Plus size={16}/></Button></div><ul className="space-y-2 mb-4">{categories.map(c => <li key={c.id} className="flex justify-between border-b pb-1"><span>{c.name}</span><button onClick={() => setCategories(categories.filter(x => x.id !== c.id))} className="text-red-400"><Trash2 size={14}/></button></li>)}</ul><div className="flex flex-col gap-2 mb-4 bg-gray-50 p-2 rounded"><select className="border p-2 rounded" value={newService.catId} onChange={e => setNewService({...newService, catId: e.target.value})}><option value="">Lier à...</option>{categories.map(c => <option key={c.id} value={c.id}>{c.name}</option>)}</select><div className="flex gap-2"><input className="border p-2 rounded flex-1" placeholder="Nom" value={newService.name} onChange={e => setNewService({...newService, name: e.target.value})} /><input type="number" className="border p-2 rounded w-24" placeholder="Prix €" value={newService.price} onChange={e => setNewService({...newService, price: e.target.value})} /><Button onClick={addService}><Plus size={16}/></Button></div></div><div className="max-h-60 overflow-y-auto"><table className="w-full text-sm"><tbody>{services.map(s => <tr key={s.id} className="border-b"><td className="text-gray-500 text-xs">{categories.find(c=>c.id===s.categoryId)?.name}</td><td>{s.name}</td><td className="font-bold">{s.standardPrice}€</td><td className="text-right"><button onClick={() => setServices(services.filter(x => x.id !== s.id))} className="text-red-400"><Trash2 size={14}/></button></td></tr>)}</tbody></table></div></Card>
                  <Card title="Sécurité"><div className="flex gap-2"><input type="password" className="border p-2 rounded flex-1" placeholder="Nouveau mot de passe" value={newPass} onChange={e => setNewPass(e.target.value)} /><Button onClick={updatePassword} variant="warning">Changer</Button></div></Card>
              </div>
          </div>
      );
  };

  const LockScreen = () => (
      <div className="flex flex-col items-center justify-center h-64 bg-gray-50 rounded-lg border border-gray-200">
          <Lock size={48} className="text-gray-400 mb-4"/><h3 className="text-lg font-bold text-gray-700 mb-4">Accès Protégé</h3>
          <form onSubmit={handleLogin} className="flex gap-2"><input type="password" autoFocus className="border p-2 rounded w-64 text-center" placeholder="Mot de passe" value={passwordInput} onChange={e => setPasswordInput(e.target.value)}/><Button type="submit">Déverrouiller</Button></form>
      </div>
  );

  return (
    <div className="min-h-screen bg-gray-100 font-sans text-gray-900">
      {notification && <Toast message={notification.message} type={notification.type} onClose={() => setNotification(null)} />}
      <EditModal />
      <div className="fixed inset-y-0 left-0 w-20 md:w-64 bg-slate-900 text-white flex flex-col no-print">
        <div className="p-4 flex items-center gap-3 border-b border-slate-700 h-16"><Scissors className="text-yellow-400" /><span className="font-bold text-xl hidden md:block">RetouchePro</span></div>
        <nav className="flex-1 py-6 space-y-2">{['reception', 'atelier', 'livraison', 'historique'].map(id => <Button key={id} variant="ghost" className={`w-full justify-start text-white ${activeTab===id?'bg-blue-600':''}`} onClick={() => setActiveTab(id)}><span className="capitalize">{id === 'livraison' ? 'Livraisons' : id}</span></Button>)}<div className="border-t border-slate-700 my-2 pt-2"><div className="px-4 text-xs text-slate-500 uppercase font-bold mb-1 hidden md:block">Admin</div>{['stats', 'config'].map(id => <Button key={id} variant="ghost" className={`w-full justify-start text-white ${activeTab===id?'bg-blue-600':''}`} onClick={() => setActiveTab(id)}><span className="capitalize">{id}</span></Button>)}</div></nav>
      </div>
      <main className="ml-20 md:ml-64 p-4 md:p-8">
        <header className="flex justify-between items-center mb-8 no-print"><h1 className="text-2xl font-bold text-gray-800 capitalize">{activeTab === 'livraison' ? 'Livraisons' : activeTab}</h1></header>
        {activeTab === 'reception' && <ReceptionModule />}
        {activeTab === 'atelier' && <WorkshopModule />}
        {activeTab === 'livraison' && <DeliveryModule />}
        {activeTab === 'historique' && <HistoryModule />}
        {['stats', 'config'].includes(activeTab) && (isAuthenticated ? <>{activeTab === 'config' && <ConfigModule />}{activeTab === 'stats' && <StatsModule />}</> : <LockScreen />)}
      </main>
    </div>
  );
}
